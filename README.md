# Vulnerability History Project ![VHP Tests](https://github.com/VulnerabilityHistoryProject/vulnerability-history/workflows/VHP%20Tests/badge.svg)

## Cite This Data

---

To cite the writing on vulnerabilityhistory.org, use: [![DOI](https://zenodo.org/badge/66301289.svg)](https://zenodo.org/badge/latestdoi/66301289)

To cite data from a specific project, use:

* Chromium [![DOI](https://zenodo.org/badge/67513158.svg)](https://zenodo.org/badge/latestdoi/67513158)
* HTTPD [![DOI](https://zenodo.org/badge/67513281.svg)](https://zenodo.org/badge/latestdoi/67513281)
* Tomcat [![DOI](https://zenodo.org/badge/166920755.svg)](https://zenodo.org/badge/latestdoi/166920755)
* Struts [![DOI](https://zenodo.org/badge/167394888.svg)](https://zenodo.org/badge/latestdoi/167394888)
* Django [![DOI](https://zenodo.org/badge/243837445.svg)](https://zenodo.org/badge/latestdoi/243837445)

## Getting Set Up

---

### __Normally__

* Install Ruby 2.7+
* Install NodeJS (latest, not LTS)
* Install Yarn
* Install PostgreSQL (latest)
* In PostgreSQL pgAdmin, create a user called "vhp". Set the permissions to "Can Log In". Create a random password and set that password for the vhp user. Put that password into secrets.yml (see next bullet). Create two databases: "vhp" and "vhp_test"
* Create a config/secrets.yml based on config/secrets.default.yml. Follow the comments in that file.
* After that, we'll need to install all of our dependencies. From the root of the repo on the command line run:

```shell
  yarn install
  bundle install
```

Then, let's set up our database and load our data:

```shell
  rails db:schema:load
  rails data:clear data:all
  rails server
```

That second one can take a while. Once the server is up, go to `http://localhost:3000` to see the site.

If you are working on the frontend, it's useful to run Webpacker's dev server:

```shell
  ruby bin/webpack-dev-server
```

This speeds up rebuilding the frontend JS, CSS, etc.

### __With Docker__

Building the project with Docker is meant to be an easy setup so there aren't any OS-specific issues throughout the dev process. That being said, this way of developing still needs 
a lot of testing to make sure it's good to go, and I wouldn't really advise trying this unless you have some time to debug too.

Setting up the containers on MacOS is as easy as installing Docker Desktop, pulling from the `vhp_docker` repo, and running a few more commands.

Since most commands are taken care of by `docker-compose up`, we just need to build the images and run them. Firstly, in the directory, run `docker-compose build`. This will build the `app` image that runs the VHP server. Since the other images have to be downloaded, `docker-compose up` should be run next. This will install all other images and run the containers. Running this command will show the server logs as well - I like this so I know what is happening/going wrong. If you don't like this dialogue, you can run `docker-compose up -d` instead, which will run the containers as daemons in the background. 

Now I'll go over each of the containers as they appear in `docker-compose.yml`.

__*redis*__

Redis helps with the server and db - don't put too much thought into it.

__*postgres*__

This is the container for our database. It uses the latest version released on dockerhub, which may cause issues in the future.

__*pgadmin*__

I like using pgAdmin to have a better visual representation of the database running. The instructions for setting up the database are the same as listed in the normal configuration. I set it to run on port `2345`.

__*app*__

This is the main rails server running on port `3000`.

__*webpacker*__

You can comment this one out if you want, but this is better for web development, so I prefer to leave it in. This runs `ruby bin/webpack-dev-server` and communicates with the VHP container. The only downside is that it adds some time to the startup process.

__*selenium*__

This is only useful for system testing, and you can comment this service out if you won't be doing any of that. More about system tests are in the `Testing` section.

__*test*__

The testing container does not continuously run after startup. It only runs when the user wants to run tests, which will be covered in the testing section.

Once the containers are up and running, and both `vhp` and `vhp_test` users have been made in the Postgres server, as well as corresponding db's, kill the containers and put in the next two commands.

```shell
  docker-compose run --rm app rails db:schema:load
  docker-compose run --rm app rails data:clear data:all
```

The second command can be changed to anything you want to do with the database. These basically spin up temporary containers of the VHP server to perform the database operations. Now, do another `docker-compose up`, wait for everything to load up, and visit `localhost:3000`. That should be it!

#### __Testing__

Testing is pretty easy to do even with containers. Regular tests can be run by running `docker-compose run --rm test <command>`

This tells docker-compose to start up a `test` container that removes itself whenever done testing. The test command can be run just like normal after that.

System testing requires one extra tool. Any VNC client will do, but I use VNC Viewer. The system tests will run fine, however to actually see the browser (if you care), you'll need to be able to get into the VNC server running on the `selenium` container. The VNC server itself runs on port `5900`, so you'll need to point the client to `0.0.0.0:5900`. Now you can observe the browser during the system tests.

#### __Reference__

This was pretty tricky to get working, if you care to know how to do this here are some articles that really helped me out.

[Rails Development with Docker](https://medium.com/better-programming/rails-6-development-with-docker-55437314a1ad)

[Running a Rails App with Webpacker and Docker](https://medium.com/@dirkdk/running-a-rails-app-with-webpacker-and-docker-8d29153d3446)

[Testing Rails Apps in Docker Containers](http://tomazy.com/blog/2017/05/testing-rails-app-in-docker-containers/)

[Using Rails 5.1 System Tests with Docker](https://medium.com/@pacuna/using-rails-5-1-system-tests-with-docker-a90c52ed0648)

## Finding useful commands

---

To find out useful commands for working with data:

`rails -T`

## Rebuild the database

---

If `db/schema.rb` has changed recently, you'll need to rebuild the database:

`rails db:schema:load`

## Reload the production data

---

To load the production data from Chromium and HTTPD:

`rails data:all`

This is the equivalent of running:

`rails data:clear data:chromium data:httpd data:writing`

To skip the clone from github,

`rails data:chromium:nogit`
`rails data:httpd:nogit`

## Useful commands

---

```shell
  rails server
  rails console
```

## Helpful Dev Tools

---

Here's a list of our favorite tools for developing this:

* [Atom](https://atom.io/) or [VS Code](https://code.visualstudio.com/)
* [Git Extensions](https://gitextensions.github.io/) for Windows Git clients
* [JSONView](https://chrome.google.com/webstore/detail/jsonview/chklaanhfefbnpoihckbnefhakgolnmc?hl=en) to format JSON responses in your browser

## The CWE csv file

---

To download a copy of the CWE csv file, go to https://cwe.mitre.org/data/downloads.html and download
the latest Research Concepts csv listed under 'Navigate CWE'.

Place the csv file in lib/taggers/resources/cwes.csv

On line 677 of the file, near the end of the line, change the double quotes around `"<script"` to single quotes `'script'`
