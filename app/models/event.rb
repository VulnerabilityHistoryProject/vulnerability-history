class Event < ApplicationRecord
  belongs_to :detail, polymorphic: true
  belongs_to :style

  def title
    embed_details(title_template)
  end

  def description
    embed_details(description_template)
  end

  def date
    DateTime.parse(embed_details(date_template))
  end

  def type
    embed_details(type_template)
  end

  private

  def embed_details(str)
    new_str = str.gsub(':title:', detail.title).
        gsub(':description:', detail.description).
        gsub(':type:', detail.type).
        gsub(':date:', detail.date.rfc2822)

    new_str = new_str.split(/(:notes[~\w]*:)/).each do |note|
      notes_tag = note.scan(/~(\w+)/).flatten
      unless notes_tag.empty? || detail.notes.empty?
        note.gsub!(/:notes[~\w]*:/, detail.notes.dig(*notes_tag).to_s)
      end
    end
    return new_str.join
  end

end
