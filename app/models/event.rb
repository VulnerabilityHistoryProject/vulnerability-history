class Event < ApplicationRecord
  belongs_to :detail, polymorphic: true


  def title
    embed_details(title_template)
  end

  def description
    embed_details(description_template)
  end

  def date
    detail.date
  end

  def type
    embed_details(type_template)
  end

  def Event.by_fixes(v)
    Event.joins( "INNER JOIN fixes ON fixes.id = events.detail_id
                                  AND events.detail_type = 'Fix'" ).
          where( fixes: { vulnerability_id: v.id } )
  end

  def Event.by_vccs(v)
    Event.joins( "INNER JOIN vccs ON vccs.id = events.detail_id
                                  AND events.detail_type = 'Vcc'" ).
          where( vccs: { vulnerability_id: v.id } )
  end

  # Pull all events directly and indirectly associated with this vulnerabilty
  #
  #  * All releases in the project
  #  * All Events where the detail is the vulnerability
  #  * All Fix events that fix this vulnerability
  #  * All VCC events for this vulnerability
  #  * TODO: Edit events to files for this vulnerability
  def Event.by_vulnerability(v)
    Event.where(detail_type: 'Release').
          or(Event.where(detail: v)) +
          Event.by_fixes(v) +
          Event.by_vccs(v)
  end

  private

  def embed_details(str)
    match = str.match(/:notes~(\w+):/)
    if(match == nil)
      match = ""
    else
      match = match[1].to_s
    end
    match2 = str.match(/:notes~(\w+)~(\w+):/)
    if(match2 == nil)
      match2 = ""
    else
      matchP1 = match2[1].to_s
      matchP2 = match2[2].to_s
    end
    str.gsub(':title:', detail.title).
        gsub(':description:', detail.description).
        gsub(':type:', detail.type).
        gsub(/:notes~(\w+):/, detail.notes.dig(match).to_s).
        gsub(/:notes~(\w+)~(\w+):/, detail.notes.dig(matchP1, matchP2).to_s)
  end


end
