class TagsController < ApplicationController
  before_action :set_tag, only: [:show]

  # GET /tags
  # GET api/tags
  def index
    @tags_with_counts = Tag.
      joins(:vulnerabilities).
      group("tags.id").
      select("tags.name", "tags.color", "tags.id", 'count(*) AS num_vulns')

    @tags = Tag.order(name: :asc).
                select("
                  *,
                  substring(tags.description from 0 for 240) || '...' as short_desc
                ")
    render_json_for_api @tags
  end

  # GET /tags/1
  # GET api/tags/1
  def show
    @vulns = Vulnerability.
      joins(:tags).
      where('vulnerability_tags.tag_id' => @tag.id).
      select('*').
      select("
        substring(vulnerabilities.description from 0 for 280)
          || '...' as short_desc
      ").
      select('vulnerability_tags.note as tag_note').
      order('vulnerabilities.upvotes desc')
    render_json_for_api(@vulns)
  end

  private
    # Use callbacks to share common setup or constraints between actions.
    def set_tag
      @tag = Tag.find(params[:id])
    end

    # Never trust parameters from the scary internet, only allow the white list through.
    def tag_params
      params.fetch(:tag, {})
    end
end
