class FilepathsController < ApplicationController
  before_action :set_filepath, only: [:show]

  # GET /filepaths
  # GET api/filepaths?offenders=true
  # GET api/filepaths
  def index
    @filepaths = if params[:offenders].to_s == 'true'
      Filepath.offenders
    else
      Filepath.all
    end
    render_json_for_api @filepaths
  end

  # GET /filepath/chromium?path=DEPS
  # GET /api/filepath/chromium?path=DEPS
  def show
    render_json_for_api @filepath
  end

  #GET /api/filepaths/4/developers
  def developers
    render_json_for_api Filepath.find(params[:filepath_id]).developers
  end

  #GET /api/filepaths/4/contributors
  def contributors
    render_json_for_api Filepath.find(params[:filepath_id]).contributors
  end

  #GET /api/filepaths/4/commits
  def commits
    render_json_for_api Filepath.find(params[:filepath_id]).commits
  end

  #GET /api/filepaths/4/vulnerabilities
  def vulnerabilities
    render_json_for_api Filepath
                          .find(params[:filepath_id])
                          .vulnerabilities(params[:short_descriptions])
  end

  private

    def set_filepath
      @project = load_project
      @filepath = load_filepath(@project)
    end

    # Never trust parameters from the scary internet, only allow the white list through.
    def filepath_params
      params.fetch(:filepath, {}).permit(:offenders)
    end

    def load_project
      if Project.exists?(subdomain: params[:project])
        return Project.find_by(subdomain: params[:project])
      else
        flash[:error] = "ERROR Project not found: #{params[:project]}"
        redirect_to controller: 'filepaths', :action => 'index'
      end
    end

    def load_filepath(project)
      if Filepath.exists?(filepath: params[:path], project: project)
        Filepath.joins(:project)
                .select('filepaths.*')
                .select('projects.subdomain')
                .select('projects.name')
                .where(filepath: params[:path], project: project)
                .take
      else
        flash[:error] = "ERROR Filepath not found: #{params[:path]}"
        redirect_to controller: 'filepaths', :action => 'index'
      end
    end

end
