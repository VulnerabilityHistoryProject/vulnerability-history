/**
 * Object representation of the punchline used to show levels of activity
 * (e.g., a developer's commit activity)
 *
 * @param chicHeight (int) - height of a chiclet
 * @param chicWidth (int) - width of a chiclet
 * @param minDate (Date) - absolute minimum date from all activities
 * @param maxDate (Date) - absolute maximum date from all activities
 * @constructor
 */
function punchline(settings) {
    this.chicHeight = settings.chicHeight;
    this.chicWidth = settings.chicWidth;
    this.iconCornerRadius = 4;
    this.min = settings.minDate;
    this.max = settings.maxDate;
    this.xAxisHeight = settings.xAxisHeight;
    this.svg;
    this.x;
    this.y;

    /**
     * Initialize the SVG, but don't draw events yet.
     */
    this.init = function() {
        this.removeSVG();
        this.initSVG();
        this.numCols = Math.floor(this.svgWidth / this.chicWidth) - 1;
        this.fadeInSVG();
    };

    this.removeSVG = function() {
        d3.select("#hPunchline").remove();
    };

    this.initXAxisScale = function() {
        halfChicWidth = this.chicWidth / 2;
        this.x = d3.scaleTime()
                   .domain([this.min, this.max])
                   .range([halfChicWidth, this.svgWidth - halfChicWidth]);
    };

    this.initYAxisScale = function() {
        this.cLim = Math.floor(this.svgHeight / (this.chicHeight + 1));
        this.y = d3.scaleLinear()
                   .domain([0, this.cLim])
                   .range([this.svgHeight, this.chicHeight]);
    };

    this.initSVG = function() {
        this.svg = d3.select('#horizontal-punchline').append("svg")
            .attr("id", "hPunchline")
            .attr('opacity', 0)
            // SVG width is dynamic, stretched to container - so not set.
            // SVG height is hardcoded to 16ems (e.g. 256px)
            // viewBox is not used either (unlike our other SVGs)
            // i.e. so our aspect ratio is not fixed at all
            .attr('width', '100%')
            .attr('height', '6em')
        this.svgWidth = parseInt(this.svg.style('width')); // compute px
        this.svgHeight = parseInt(this.svg.style('height')); // compute px
        this.initXAxisScale();
        this.initYAxisScale();
    };

    // Do a CSS fade in
    this.fadeInSVG = function() {
        d3.select('#hPunchline')
          .transition()
          .duration(750)
          .attr('opacity', 1);
    };

    // Do a CSS fade in
    this.fadeOutSVG = function() {
        d3.select('#hPunchline')
          .transition()
          .duration(750)
          .attr('opacity', 0);
    };

    this.drawChic = function(event_date, yIndex) {
        var self = this;
        this.svg.append("svg:rect") // draw the chiclets
            .attr("class", "bin link_to_event ")
            .attr("x", function () {
                // map through d3's scaleTime(), center on chiclet
                return self.x(event_date);
            })
            .attr("y", function () {
                // map through d3's scaleLinear()
                // yIndex + 1 to be 1-chiclet above timeline
                return self.y(yIndex) + 1;
            })
            .attr("width", self.chicWidth - 3) // adjust for gap
            .attr("height", self.chicHeight - 3) // ajdust for a gap
            .attr("rx", self.iconCornerRadius)
            .attr("ry", self.iconCornerRadius)
            .attr("fill", "lightgray")
            .on("mouseenter", function () {
                d3.select(this).attr("stroke", "#000");
            })
            .on("mouseleave", function () {
                d3.select(this).attr("stroke", "");
            });
    };

    this.plotActivities = function() {
        // 52 rows, 7 columns
        for (let date = moment(this.min); date.diff(this.max) < 0; date.add(7, 'days')) {
            for (var i = 0; i < 7; i++) {
                punch.drawChic(date, i);
            }
        }
    }
}
