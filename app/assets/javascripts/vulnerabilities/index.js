function columnsInfo(){
  return [
    {
      title: '<i class="fi-flag"></i> CVE',
      data: 'cve',
      defaultContent: '',
      class:'text-center'
    },
    {
      title: '<i class="fi-info"></i> Description',
      data: 'short_desc',
      defaultContent: '',
      class:'text-left'
    },
    {
      title: '<i class="fi-megaphone"></i> Date',
      data: 'announced',
      defaultContent: '',
      class:'text-center',
      render: function(data) {
        return moment(data).format('MMMM DD, YYYY');
      }
    },
    {
      title: '<i class="fi-like"></i>',
      data: 'upvotes',
      defaultContent: '0',
      class:'text-center'
    },
    {
      title: '<i class="fi-flag"></i> Nickame',
      data: 'nickname',
      defaultContent: '0',
      class:'text-center'
    },
    {
      title: '<i class="fi-pricetag-multiple"></i> Tags',
      data: 'tag_names',
      defaultContent: '',
      class:'text-left'
    }
  ];
}

$( document ).ready( function() {
    $.ajax({
        url: "/api/vulnerabilities?short_descriptions=true",
        dataType: 'json',
        success: function(jsonData) {
            $('#datatable').dataTable({
                destroy: true,
                data: jsonData,
                order: [[3, "desc"]], /* Default sort */
                rowCallback: function(row, data, index){
                  $(row).on('click', function(){
                    var url = window.location.href;
                    if (url.slice(-1) == "/"){
                      url += data.id;
                    } else {
                      url += '/' + data.id;
                    }
                    window.location.assign(url);
                  })
                },
                columnDefs: [
                  { "width": "10%", "targets": 0 }
                ],
                columns: columnsInfo(),
                initComplete: function () {
                    $('#loading').remove();
                    var nav = $('#datatable_wrapper .row');
                    nav.removeClass('row')
                    nav.addClass('table-nav grid-x'); /* Foundation 6 XY Grid */
                    nav.children()
                        .removeClass('small-6') /* Foundation 6 XY Grid */
                        .removeClass('columns') /* Foundation 6 XY Grid */
                    nav.children().first()
                        .addClass('table-nav-show-entries cell small-2');
                    nav.children().first().after(
                      '<div class="table-nav-filter cell small-3">' +
                      '  <select id="tag_filters" name="tag_filters" class="tag-filter">' +
                      '    <option value="" selected></option>'+
                      '    <option value="" disabled>--Filter by Tags--</option>'+
                      '  </select>' +
                      '</div>'
                    );
                    nav.children().first().next().after(
                      '<div class="table-nav-more-about cell small-3 text-center">' +
                        // ajax call to /api/tags will populate here
                      '</div>'
                    );
                    nav.children().first().next().next().next()
                        .addClass('table-nav-search cell small-4');
                    this.api().columns(4).every( function () {
                        var column = this;
                        $('#tag_filters').on( 'change', function () {
                            column.search($(this).val()).draw();
                            $('.table-nav-more-about-link').hide();
                            var tag_id = $(this).find(':selected').data('tag-id');
                            $('#table-nav-tag-' + tag_id).show();
                        } );
                        $.ajax({
                            url: "/api/tags",
                            dataType: "json",
                            success: function (data) {
                                data.sort(function(a, b) {
                                   return a.name.localeCompare(b.name);
                                });
                                $.each(data, function ( index, d ) {
                                    $('#tag_filters').append(
                                      '<option value="' + d.name + '"' +
                                      '        data-tag-id="'+ d.id +'">'
                                        + d.name +
                                       '</option>'
                                    );
                                    $('.table-nav-more-about').append(
                                      '<a href="/tags/' + d.id + '" ' +
                                        ' class="table-nav-more-about-link"' +
                                        ' id="table-nav-tag-' + d.id + '">'+
                                        '<i class="fi-pricetag-multiple"/></i> Learn about ' +
                                        d.name +
                                      '</a>');
                                } );
                                $('.table-nav-more-about-link').hide();
                            }
                        });
                    } );
                }
            });
        }
    });

    $('#datatable').on('mouseover', 'tbody tr', function() {
        $(this).css({
           'cursor': 'pointer',
            'color': 'blue'
        });
    })

    $('#datatable').on('mouseout', 'tbody tr', function() {
        $(this).css({
            'cursor': 'default',
            'color': 'inherit'
        });
    })
});
