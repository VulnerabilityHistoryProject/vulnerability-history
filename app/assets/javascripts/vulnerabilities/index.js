$( document ).ready( function() {
    $.ajax({
        url: "/api/vulnerabilities?short_descriptions=true",
        dataType: 'json',
        success: function(jsonData) {
            $('#datatable').dataTable({
                destroy: true,
                data: jsonData,
                order: [[3, "desc"]],
                rowCallback: function(row, data, index){
                  $(row).on('click', function(){
                    var url = window.location.href;
                    if (url.slice(-1) == "/"){
                      url += data.id;
                    } else {
                      url += '/' + data.id;
                    }
                    window.location.assign(url);
                  })
                },
                columnDefs: [
                  { "width": "10%", "targets": 0 }
                ],
                columns: [
                    { title: 'CVE', data: 'cve', defaultContent: ''},
                    { title: 'Description', data: 'short_desc', defaultContent: ''},
                    { title: 'Date', data: 'announced', defaultContent: '',
                      render: function(data) {
                        return moment(data).format('MMMM DD YYYY, h:mm a');
                      }
                    },
                    { title: 'Upvoted', data: 'upvotes', defaultContent: 'Null'},
                    { title: 'Tags', data: 'tag_names', defaultContent: ''}
                ],
                initComplete: function () {
                    $('#loading').remove();
                    this.api().columns(4).every( function () {
                        var column = this;
                        $('#datatable_wrapper .row').children().removeClass('small-6').addClass('small-4');
                        $("#datatable_wrapper .row:first").append('<div class="columns small-4"></div><label id="tag_filters_label">Filters</label></div>');
                        var select = $('<select id="tag_filters" name=tag_filters" class="tag-filter"><option value="" selected></option></select>')
                            .val(1)
                            .appendTo( $('#tag_filters_label') )
                            .on( 'change', function () {
                                var val = $.fn.dataTable.util.escapeRegex(
                                    $(this).val()
                                );
                                column.search(val).draw();
                            } );
                        $.ajax({
                            url: "/api/tags",
                            dataType: "json",
                            success: function (data) {
                                data.sort(function(a, b) {
                                   return a.name.localeCompare(b.name);
                                });
                                $.each(data, function ( index, d ) {
                                    select.append( '<option value="'+d.name+'">'+d.name+'</option>' )
                                } );
                            }
                        });
                    } );
                }
            });
        }
    });

    $('#datatable').on('mouseover', 'tbody tr', function() {
        $(this).css({
           'cursor': 'pointer',
            'color': 'blue'
        });
    })

    $('#datatable').on('mouseout', 'tbody tr', function() {
        $(this).css({
            'cursor': 'default',
            'color': 'inherit'
        });
    })
});
