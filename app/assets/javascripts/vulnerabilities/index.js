function columnsInfo(){
  return [
    {
      title: '<i class="fi-flag"></i> CVE',
      data: null,
      defaultContent: '',
      class:'text-center',
      render: function(data){
        return vulnName(data);
      }
    },
    {
      title: '<i class="fi-info"></i> Description',
      data: 'short_desc',
      defaultContent: '',
      class:'text-left'
    },
    {
      title: '<i class="fi-megaphone"></i> Date',
      data: 'announced',
      defaultContent: '',
      class:'text-center',
      render: function(data) {
        return moment(data).format('MMMM DD, YYYY');
      }
    },
    {
      title: '<i class="fi-like"></i>',
      data: 'upvotes',
      defaultContent: '0',
      class:'text-center'
    },
    {
      title: '<i class="fi-pricetag-multiple"></i> Tags',
      data: 'tag_names',
      defaultContent: '',
      class:'text-left'
    }
  ];
}

function languageInfo() {
  return {
    search: "", // nothing in the placeholder;
    searchPlaceholder: 'Search',
    lengthMenu: "Show _MENU_",
    info: "Showing _START_ to _END_ of _TOTAL_ vulnerabilities",
    infoEmpty: "Showing 0 to 0 of 0 entries",
    infoFiltered: "(filtered from _MAX_ total vulnerabilities)",
  };
}

function buildTopNav() {
  $('#datatable_wrapper').prepend('<div id="table-nav-top"></div>');
  var nav = $('#table-nav-top');
  nav.addClass('table-nav grid-x');

  var nav_length = $('#datatable_length');
  nav_length.addClass('table-nav-show-entries cell small-2')
  nav.append(nav_length);

  nav.append(
    '<div class="table-nav-filter cell small-3">' +
    '  <select id="tag_filters" name="tag_filters" class="tag-filter">' +
    '    <option selected></option>'+
    '    <option disabled value> --- Filter by Tags --- </option>'+
    '  </select>' +
    '</div>'
  );

  nav.append(
    '  <div class="table-nav-more-about text-center cell small-4">' +
        // ajax call to /api/tags will populate here
    '  </div>'
  );

  var nav_search = $('#datatable_filter label');
  nav_search.addClass('table-nav-search cell small-3')
  nav.append(nav_search);
}

$( document ).ready( function() {
    $.ajax({
        url: "/api/vulnerabilities?short_descriptions=true",
        dataType: 'json',
        success: function(jsonData) {
            $('#datatable').DataTable({
                destroy: true,
                data: jsonData,
                order: [[3, "desc"]], /* Default sort */
                rowCallback: function(row, data, index){
                  $(row).on('click', function(){
                    var url = '/vulnerabilities/' + data.id;
                    window.location.assign(url);
                  })
                },
                columnDefs: [
                  { "width": "10%", "targets": 0 }
                ],
                columns: columnsInfo(),
                language: languageInfo(),
                initComplete: function () {
                    $('#loading').remove();
                    buildTopNav();
                    this.api().columns(4).every( function () {
                        var column = this;
                        $('#tag_filters').on( 'change', function () {
                            column.search($(this).val()).draw();
                            $('.table-nav-more-about-link').hide();
                            var tag_id = $(this).find(':selected').data('tag-id');
                            $('#table-nav-tag-' + tag_id).show();
                        } );
                        $.ajax({
                            url: "/api/tags",
                            dataType: "json",
                            success: function (data) {
                                data.sort(function(a, b) {
                                   return a.name.localeCompare(b.name);
                                });
                                $.each(data, function ( index, d ) {
                                    $('#tag_filters').append(
                                      '<option value="' + d.name + '"' +
                                      '        data-tag-id="'+ d.id +'">'
                                        + d.name +
                                       '</option>'
                                    );
                                    $('.table-nav-more-about').append(
                                      '<a href="/tags/' + d.id + '" ' +
                                        ' class="table-nav-more-about-link"' +
                                        ' id="table-nav-tag-' + d.id + '">'+
                                        '<i class="fi-pricetag-multiple"/></i> Learn about ' +
                                        d.name +
                                      '</a>');
                                } );
                                $('.table-nav-more-about-link').hide();
                            }
                        });
                    } );
                }
            });
        }
    });

    $('#datatable').on('mouseover', 'tbody tr', function() {
        $(this).css({
           'cursor': 'pointer',
            'color': 'blue'
        });
    })

    $('#datatable').on('mouseout', 'tbody tr', function() {
        $(this).css({
            'cursor': 'default',
            'color': 'inherit'
        });
    })
});
