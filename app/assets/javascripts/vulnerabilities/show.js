function initHTimeline(){
  window.filters = [];
  settings = {
    margin: { top: 10, bottom: 45, left: 60, right: 60},
    chicHeight: 14,
    chicWidth: 20,
    cLowerLim: 13,
    cUpperLim: 15,
    zoom: 100,
    hiddenTypes: [],
    xAxisHeight: 43,
    fade_ms: 700,
  }

  var h = new timelines(settings);
  h.init();
  $(document).on("change", ".htimeline_toggle", () => h.filterToggled());
  $('#zoom-dropdown').click((event) => h.zoomChanged(event.currentTarget.value));
  $('#zoom-icon').click(() => h.moveViewRight());
  return h;
}

/**
 * sort the events by date oldest to newest
 * @param events - array of hashes with a "date" object
 * @returns {*} - array of sorted event hashes
 */
function sortEvents(events) {
    events.sort(function(a, b) {
        var a = new Date(a.date);
        var b = new Date(b.date);
        return b.getTime() - a.getTime();
    });
    return events;
}

function populateHTimeline(hTimeline, vulnEvents) {
    if(vulnEvents.length == 0) { return; }
    vulnEvents = sortEvents(vulnEvents);
    hTimeline.update(vulnEvents);
}

function populateVTimeline(vulnEvents) {
  vulnEvents = sortEvents(vulnEvents);
  for (let e of vulnEvents) {
    block = $('#vtimeline-template').clone();
    block.attr('id', 'event_block_' + e.id);
    block.attr('data-id', e.id);
    block.attr('data-type', e.event_type);
    block.find('.vtimeline-anchor').attr('id',"event_" + e.id);
    block.find('#title').html(e.title);
    block.find('#description').html(e.description);
    block.find('#description').addClass('shortened'); // applies fading
    block.find('#isodate').html(e.date);
    block.find('#pretty_date').html(moment(e.date).format('MMMM DD, YYYY'));
    block.find('#timeline-icon').html(e.style_icon);
    block.find('.vtimeline-img').css('background-color', e.style_color);
    $('#vtimeline').append(block);
    block.show();

    // Hide "See More" and "See Less" elements if the description
    // is small enough or if there is a trivial amount of overflow
    desc = block.find('#description');
    if (desc.prop('scrollHeight') - desc.prop('clientHeight') < 75) {
      desc.removeClass('shortened');
      desc.css('height', 'initial');
      block.find('.see_more').remove();
      block.find('.see_less').remove();
    }
  }
  $('#vtimeline-template').remove(); // remove so we start upper-left

  // Expand event description when clicked
  $('.see_more').click(function() {
    $(this).attr('hidden', 'true');
    $(this).parent().find('#description').css('height', 'initial');
    $(this).parent().find('#description').toggleClass('shortened');
    $(this).parent().find('.see_less').removeAttr('hidden');
  });

  // Shorten event description when clicked
  $('.see_less').click(function() {
    $(this).attr('hidden', 'true');
    $(this).parent().find('#description').css('height', '');
    $(this).parent().find('#description').toggleClass('shortened');
    $(this).parent().find('.see_more').removeAttr('hidden');
  });
}

$( document ).ready( function() {
  var hTimeline = initHTimeline();
  var events = []; // global to the page for resizing

  $.ajax({
    url: "/api/vulnerabilities/" + vulnerability_id + "/events",
    dataType: 'json',
  }).done(function(vulnEvents){
    $('#vtimeline_loading').remove();
    populateVTimeline(vulnEvents);
  }).done(function(vulnEvents) {
    for(let e of vulnEvents) {
        e.date = new Date(e.date); //Rails AR date string to JS date object
        events.push(e); //set to global events
    }
    $('#htimeline-loading').hide();
    populateHTimeline(hTimeline, events);
  });

  window.onresize = function() {
    $('#htimeline-loading').show();
    hTimeline = initHTimeline();
    $('#htimeline-loading').hide();
    populateHTimeline(hTimeline, events);
  }

});
