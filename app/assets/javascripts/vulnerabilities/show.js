function initHTimeline(){
  window.filters = [];
  settings = {
    margin: { top: 10, bottom: 45, left: 60, right: 60},
    chicHeight: 14,
    chicWidth: 20,
    cLowerLim: 13,
    cUpperLim: 15,
    zoom: true,
    hiddenTypes: [],
    xAxisHeight: 43,
    fade_ms: 700,
  }

  var h = new timelines(settings);
  h.init();
  $(document).on("change", ".htimeline_toggle", () => h.filterToggled());
  $('#zoom-button').click(() => h.zoomToggled());
  return h;
}

// Find the following dates:
//   * minDate - maximum vulnerability event date, used in zoom-out
//   * maxDate - maximum vulnerability event date, used in zoom-out
//   * minZoomDate - earliest Vcc
//   * maxZoomDate - latest Fix
//   * zoom comment - title text of what you're zooming into
function findImportantDates(vuln_events){
  minDate = vuln_events[vuln_events.length - 1].date;
  maxDate = vuln_events[0].date;
  minZoomDate = minDate; // might be overwritten
  maxZoomDate = maxDate; // might be overwritten
  vuln_events.forEach(function(e) {
    if(e.type == 'vcc'){
      minZoomDate = (e.date > minZoomDate) ? e.date : minZoomDate;
    } else if (e.type == 'fix') {
      maxZoomDate = (e.date < maxZoomDate) ? e.date : maxZoomDate;
    }
  });
  return {
    minDate: minDate,
    maxDate: maxDate,
    minZoomDate: minZoomDate,
    maxZoomDate: maxZoomDate,
    zoomComment: 'Zoom to the vulnerability origins and fixes'
  }
}

/**
 * sort the events by date oldest to newest
 * @param events - array of hashes with a "date" object
 * @returns {*} - array of sorted event hashes
 */
function sortEvents(events) {
    events.sort(function(a, b) {
        var a = new Date(a.date);
        var b = new Date(b.date);
        return b.getTime() - a.getTime();
    });
    return events;
}

function populateHTimeline(hTimeline, vuln_events) {
    if(vuln_events.length == 0) { return; }
    vuln_events = sortEvents(vuln_events);
    importantDates = findImportantDates(vuln_events);
    hTimeline.update(vuln_events, importantDates);
}

function populateVTimeline(vuln_events) {
  vuln_events = sortEvents(vuln_events);
  for (let e of vuln_events) {
    block = $('#vtimeline-template').clone();
    block.attr('id', 'event_block_' + e.id);
    block.attr('data-id', e.id);
    block.attr('data-type', e.event_type);
    block.find('.vtimeline-anchor').attr('id',"event_" + e.id);
    block.find('#title').html(e.title);
    block.find('#description').html(e.description);
    block.find('#description').addClass('shortened'); // applies fading
    block.find('#isodate').html(e.date);
    const event_date = moment(e.date,'YYYY-MM-DD hh:mm:ss Z')
                       .format('MMMM DD, YYYY');
    block.find('#pretty_date').html(event_date);
    block.find('#timeline-icon').html(e.style_icon);
    block.find('.vtimeline-img').css('background-color', e.style_color);
    $('#vtimeline').append(block);
    block.show();

    // Hide "See More" and "See Less" elements if the description
    // is small enough or if there is a trivial amount of overflow
    desc = block.find('#description');
    if (desc.prop('scrollHeight') - desc.prop('clientHeight') < 75) {
      desc.removeClass('shortened');
      desc.css('height', 'initial');
      block.find('.see_more').remove();
      block.find('.see_less').remove();
    }
  }
  $('#vtimeline-template').remove(); // remove so we start upper-left

  // Expand event description when clicked
  $('.see_more').click(function() {
    $(this).attr('hidden', 'true');
    $(this).parent().find('#description').css('height', 'initial');
    $(this).parent().find('#description').toggleClass('shortened');
    $(this).parent().find('.see_less').removeAttr('hidden');
  });

  // Shorten event description when clicked
  $('.see_less').click(function() {
    $(this).attr('hidden', 'true');
    $(this).parent().find('#description').css('height', '');
    $(this).parent().find('#description').toggleClass('shortened');
    $(this).parent().find('.see_more').removeAttr('hidden');
  });
}

$( document ).ready( function() {
  var hTimeline = initHTimeline();
  var events = []; // global to the page for resizing

  $.ajax({
    url: "/api/vulnerabilities/" + vulnerability_id + "/events",
    dataType: 'json',
  }).done(function(vuln_events){
    $('#vtimeline_loading').remove();
    populateVTimeline(vuln_events);
  }).done(function(vuln_events) {
    for(let e of vuln_events) {
        e.date = new Date(e.date); //Rails AR date string to JS date object
        events.push(e); //set to global events
    }
    $('#htimeline-loading').hide();
    populateHTimeline(hTimeline, events);
  });

  window.onresize = function() {
    $('#htimeline-loading').show();
    hTimeline = initHTimeline();
    $('#htimeline-loading').hide();
    populateHTimeline(hTimeline, events);
  }

});
