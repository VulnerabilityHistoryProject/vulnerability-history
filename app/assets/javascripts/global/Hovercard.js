import $ from 'jquery';

/**
 * Set a hovercard to load and present the selected vulnerability.
 * @param {*} elementSelect The class name of the elements that will have a hovercard.
 */
export default function setHovercard(elementSelect) {

    // Add hovercard div to elements with the given selector
    $(elementSelect).append('<div class="hover-card"></div>')

    // Initiate the hovercard element style and hide it
    $('.hover-card').css({
        display: 'inline-flex',
        position: 'absolute',
        backgroundColor: '#23232c',
        borderRadius: '17pt',
        borderLeft: '4pt solid #98e3b7',
        padding: '0.8em',
        height: '12em',
        width: '13em',
        color: '#98e3b7'
    }).hide()

    // Show the hovercard when hovering over the given elements and hide it when
    // hovering off it and the hovercard
    $(elementSelect).hover(function (e) { // when hovering over the link
            $(this)
                .find('.hover-card').css({ // spawn the hovercard centered at the cursor right below the chosen element
                left: e.pageX - $(this).find('.hover-card').width() / 2, // center with the cursor
                top: $(this)[0].getBoundingClientRect().bottom + window.pageYOffset - 3 // right below the element
            })
                .fadeIn(100)
            ajaxReq($(this))
        },
        function () { // when hovering off the link
            $(this).find('.hover-card').fadeOut(100)
        }
    )
}

// fetch request for vulnerability data
function populateHovercard(result, cve) {
    const title = $('<div></div>').text(cve.text()).css({
        display: 'flex',
        flexDirection: 'column',
        marginBottom: '0.3em',
        fontWeight: 'bold',
        textAlign: 'left'
    })
    const title_description_div = $('<div></div>').css({
        display: 'flex',
        flexDirection: 'column',
        alignItems: 'flex-start'
    })
    const nickname = $('<span></span>').text(result['nickname']).css({
        fontSize: '0.8em',
        fontWeight: '100',
        fontStyle: 'italic'
    })
    const announced = $('<span></span>').text(result['announced'].substring(0,10)).css({
        fontSize: '0.6em',
        fontWeight: '500',
        color: '#ea5f49'
    })
    const icons = $('<div></div>').text("I C O N S T A B").css({
        display: 'inline',
        width: '2em',
        height: '100%',
        marginRight: '1em'
    })
    const description = $('<p></p>').text(result['description'].substring(0, 165) + '...').css({
        display: 'flex',
        fontSize: '0.7em',
        textAlign: 'left',
        color: 'white',
        lineHeight: '1.6em'
    })
    title.append(nickname, announced)
    title_description_div.append(title, description)
    $(cve).find('.hover-card').append(icons, title_description_div)
}

function ajaxReq(element){
    $.ajax({
        url: 'https://vulnerabilityhistory.org/api/vulnerabilities/' + element.text(),
        dataType: 'json',
        success: (response) => {
            populateHovercard(response, element)
        }
    })
}