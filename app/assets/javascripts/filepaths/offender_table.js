function buildTopNav() {
    $('#datatable_wrapper').prepend('<div id="table-nav-top"></div>');
    const nav = $('#table-nav-top');
    nav.addClass('table-nav grid-x');

    const nav_length = $('#datatable_length');
    nav_length.addClass('table-nav-show-entries cell small-5')
    nav.append(nav_length);

    const nav_search = $('#datatable_filter label');
    nav_search.addClass('table-nav-search cell small-3')
    nav.append(nav_search);
}

function languageInfo() {
    return {
        search: "", // nothing in the placeholder;
        searchPlaceholder: 'Search',
        lengthMenu: "Show _MENU_",
        info: "Showing _START_ to _END_ of _TOTAL_ offenders",
        infoEmpty: "Showing 0 to 0 of 0 entries",
        infoFiltered: "(filtered from _MAX_ total offenders)",
    };
}

$( document ).ready( function() {
    $.ajax({
        url: "/api/filepaths?offenders=true",
        dataType: 'json',
        success: function(jsonData) {
            $('#datatable').dataTable({
                responsive: true,
                destroy: true,
                data: jsonData,
                order: [[2, "desc"]], /* Default sort */
                columnDefs: [],
                columns:  [
                    {
                        title: 'File path',
                        data: 'filepath',
                        defaultContent: '',
                        className: 'filepath',
                        responsivePriority: 1,
                        render: (data, type, row) => renderAsLink(data, row)
                    },
                    {
                        title: 'Fixes',
                        data: 'num_fixes',
                        defaultContent: '',
                        responsivePriority: 2,
                        render: (data, type, row) => renderAsLink(data, row)
                    },
                    {
                        title: 'CVEs',
                        data: 'num_cves',
                        defaultContent: '',
                        responsivePriority: 3,
                        render: (data, type, row) => renderAsLink(data, row)
                    },
                    {
                        title: 'CVEs',
                        data: 'cves',
                        defaultContent: '',
                        responsivePriority: 4,
                        render: (data, type, row) => renderAsLink(data, row)
                    }
                ],
                language: languageInfo(),
                initComplete: function () {
                    $('#loading').remove();
                    buildTopNav();
                  }
            });
        }
    });

    $('#datatable').on('mouseover', 'tbody tr', function() {
        $(this).css({
           'cursor': 'pointer',
            'color': 'blue'
        });
    })

    $('#datatable').on('mouseout', 'tbody tr', function() {
        $(this).css({
            'cursor': 'default',
            'color': 'inherit'
        });
    })
});

function renderAsLink(data, row) {
    return '<a class="dt_row" href="/filepaths/' + row.id + '">' + data + '</a>';
}
