// Table for the "vulnerabilities" tab (not yet implemented)
$( document ).ready( function() {
  var url = `/api/filepaths/%{$('#filepath_id').text()}/vulnerabilities?short_descriptions=true`;
  $.ajax({
      url: url,
      dataType: 'json',
      success: function(jsonData) {
          vulnTable(jsonData, '#vulndatatable')
      }
  });
});

// Table for the "edits" tab (aka commits)
function buildTopNav() {
    $('#datatable_wrapper').prepend('<div id="table-nav-top"></div>');
    const nav = $('#table-nav-top');
    nav.addClass('table-nav grid-x');

    const nav_length = $('#datatable_length');
    nav_length.addClass('table-nav-show-entries cell small-9')
    nav.append(nav_length);

    const nav_search = $('#datatable_filter label');
    nav_search.addClass('table-nav-search cell small-3')
    nav.append(nav_search);
}

function languageInfo() {
    return {
        search: "", // nothing in the placeholder;
        searchPlaceholder: 'Search',
        lengthMenu: "Show _MENU_",
        info: "Showing _START_ to _END_ of _TOTAL_ commits",
        infoEmpty: "Showing 0 to 0 of 0 entries",
        infoFiltered: "(filtered from _MAX_ total commits)",
    };
}

$( document ).ready( function() {
    $.ajax({
        url: "/api/filepaths/" +
            $('.filepath_id').data('id') +
            "/commits",
        dataType: 'json',
        success: function (jsonData) {
            $('#edit_table').dataTable({
                responsive: true,
                destroy: true,
                data: jsonData,
                order: [[2, "desc"]], /* Default sort */
                columnDefs: [],
                columns: [
                    {
                        title: 'Commit No',
                        data: 'title',
                        defaultContent: '',
                        className: 'title',
                        responsivePriority: 1,
                        render: (data, type, row) => renderAsLink(data, row)
                    },
                    {
                        title: 'Commit Message',
                        data: 'description',
                        defaultContent: '',
                        responsivePriority: 2,
                        render: (data, type, row) => renderAsLink(data, row)
                    },
                    {
                        title: 'Date',
                        data: 'date',
                        defaultContent: '',
                        responsivePriority: 3,
                        render: (data, type, row) => renderAsLink(data, row)
                    }
                ],
                language: languageInfo(),
                initComplete: function () {
                    $('#loading').remove();
                    buildTopNav();
                }
            });
        }
    });

    $('#edit_table').on('mouseover', 'tbody tr', function () {
        $(this).css({
            'cursor': 'pointer',
            'color': 'blue'
        });
    })

    $('#edit_table').on('mouseout', 'tbody tr', function () {
        $(this).css({
            'cursor': 'default',
            'color': 'inherit'
        });
    });
});

function renderAsLink(data, row) {
    return '<a class="dt_row" href="/filepaths/' + row.id + '">' + data + '</a>';
}