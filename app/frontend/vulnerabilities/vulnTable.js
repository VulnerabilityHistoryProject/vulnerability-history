import $ from 'jquery'
import 'datatables.net'
import 'datatables.net-responsive-dt'
import 'datatables.net-zf'
import {vulnProject, vulnName} from '../global/dataToPrettyStrings'
import {hideSinglePagePagination} from '../global/datatablesTweaks'
import {shortDate} from '../global/dates'

/*
 Main listing of all vulnerabilities
*/

export function vulnTable(jsonData, tableName = '#datatable') {
  $(tableName).dataTable({
    responsive: true,
    destroy: true,
    data: jsonData,
    order: [ [3, "desc"] ], /* Default sort */
    columns: columnsInfo(),
    language: languageInfo(),
    preDrawCallback: (settings) => hideSinglePagePagination(settings),
    initComplete: function() {
      $('#loading').remove();
      buildTopNav();
      this.api().columns(4).every(function() {
        var column = this;
        $('#tag_filters').on('change', function() {
            column.search($(this).val()).draw();
            $('.table-nav-more-about-link').hide();
            var tag_id = $(this).find(':selected').data('tag-id');
            $('#table-nav-tag-' + tag_id).show();
        });
        $.ajax({
          url: "/api/tags",
          dataType: "json",
          success: function(data) {
            data.sort(function(a, b) {
              return a.name.localeCompare(b.name);
            });
            $.each(data, function(index, d) {
              $('#tag_filters').append(
                `<option value="${d.name}" data-tag-id="${d.shortname}">
                  ${d.name}
                </option>`);
              $('.table-nav-more-about').append(
                `<a href="/tags/${d.shortname}"
                    class="table-nav-more-about-link"
                    id="table-nav-tag-${d.shortname}">
                      <i class="vhp-icon-${d.icon}" style="color: ${d.color}"/></i>
                      Learn about ${d.name}
                </a>`);
            });
            $('.table-nav-more-about-link').hide();
          }
        });
      });
    }
  });
  $(tableName).on('mouseover', 'tbody tr', function() {
    $(this).css({
      'cursor': 'pointer',
      'color': 'blue'
    });
  });
  $(tableName).on('mouseout', 'tbody tr', function() {
    $(this).css({
      'cursor': 'default',
      'color': 'inherit'
    });
  })
}

function columnsInfo() {
  return [{
      title: '<i class="vhp-icon-vulnerability"></i> Vulnerability',
      data: null,
      defaultContent: '',
      class: 'text-center',
      responsivePriority: 1,
      width: '12em',
      render: (data) => vulnLink(data, vulnProject(data) + vulnName(data)),
    },
    {
      title: '<i class="vhp-icon-info"></i> Description',
      data: null,
      defaultContent: '',
      class: 'text-left',
      responsivePriority: 3,
      render: (data) => vulnLink(data, data.short_desc)
    },
    {
      title: '<i class="vhp-icon-announce"></i> Date',
      data: null,
      defaultContent: '',
      class: 'text-center',
      responsivePriority: 5,
      width: '10em',
      render: (data) => vulnLink(data, shortDate(data.announced))
    },
    {
      title: '<i class="vhp-icon-upvote"></i>',
      data: 'upvotes',
      defaultContent: '0',
      class: 'text-center',
      responsivePriority: 2,
    },
    {
      title: '<i class="vhp-icon-tags"></i> Tags',
      data: null,
      defaultContent: '',
      width: '40%',
      class: 'text-left',
      responsivePriority: 4,
      render: (data) => renderTags(data)
    }
  ]
}

function vulnLink(data, str) {
  return `<a class="dt_row" href="/vulnerabilities/${data.id}">${str}</a>`
}

function languageInfo() {
  return {
    search: "", // nothing in the placeholder;
    searchPlaceholder: 'Search',
    lengthMenu: "Show _MENU_",
    info: "Showing _START_ to _END_ of _TOTAL_ vulnerabilities",
    infoEmpty: "Showing 0 to 0 of 0 entries",
    infoFiltered: "(filtered from _MAX_ total vulnerabilities)",
  };
}

function buildTopNav() {
  $('#datatable_wrapper').prepend('<div id="table-nav-top"></div>');
  var nav = $('#table-nav-top');
  nav.addClass('table-nav grid-x');

  var nav_length = $('#datatable_length');
  nav_length.addClass('table-nav-show-entries cell small-2')
  nav.append(nav_length);

  nav.append(`
    <div class="table-nav-filter cell small-3">
      <select id="tag_filters" name="tag_filters" class="tag-filter">
        <option selected value> --- Filter by Tags --- </option>
      </select>
    </div>`
  );

  nav.append(
    `<div class="table-nav-more-about text-center cell small-4">
    <!-- ajax call to /api/tags will populate here -->
    </div>`
  );

  var nav_search = $('#datatable_filter label');
  nav_search.addClass('table-nav-search cell small-3')
  nav.append(nav_search);
}

function renderTags(data) {
  let str = "<span class='tag-list'>";
  for (let t of data.tag_json) {
    str += `<a href="/tags/${t.tag_shortname}" class='tag-list-item'>
              <i class='vhp-icon-${t.tag_icon}' style="color: ${t.tag_color}" ></i>
              <span>
                ${t.tag_name}
              </span>
            </a>`;
  }
  str += "</span>";
  return str;
}
