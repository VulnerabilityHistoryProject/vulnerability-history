import $, { Deferred } from 'jquery'
import { vulnTable, updateVulnTable } from './vulnTable'
import { vulnCards } from './vulnCards'
import { setHoverCard } from '../global/cve_hovercard'



function load_succeded(vTable, ajaxResponse) {
  $('#loading').hide();
  const vData = ajaxResponse[0];
  updateVulnTable(vTable, vData);
  vulnCards(vData, tagMap);
  setHoverCard('#datatable', '.dt_row');
}

function load_failed(vTable, ajaxResponse) {
  $('#loading').hide();
  $('#downloading-more').remove();
  $('#loading-failed').show();
}

$(function() {
  //tagMap was defined in index.html.erb
  const vulnURL = "/api/vulnerabilities?short_descriptions=true&offset=10"
  $.when(
    vulnTable(initVulnData, tagMap),            // init the table
    $.ajax({ url: vulnURL, dataType: 'json', }) // get the full data
  ).then(load_succeded, load_failed);
});
