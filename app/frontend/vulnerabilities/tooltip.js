import $ from 'jquery';

/**
 * TODO: There is a race condition taking place when rendering the tooltip. When the iframe loads it resizes to fit it's content. However,
 * every so often the content adjusts after the iframe has already been resized. I believe this to be an issue regarding how the icons
 * and images in the iframe content are rendered.
 */

/**
 * Set an iframe that is a tooltip to load and present the selected vulnerability.
 * @param {*} containerSelect The parent element holding the observable elements. This is where the tooltip will work.
 * @param {*} elementSelect  The elements holding the id of the vulnerability (what is selected).
 */
export function setTooltip(containerSelect, elementSelect) {
    // Tooltip offest from Cursor
    var cursorTopOffset = 30;
    var cursorLeftOffset = 30;

    // Permanaent Styling Tweaks for Tooltip Loading image.
    $("#tool_tip").find('.loading').find('img').css({
        'top': 0,
        'left': 0,
        'margin-left': 0,
        'margin-top': 0
    });
    
    // Render the Tooltip for the new CVE
    $('.vuln_tool_tip').on('load', function(e) {
        let id = $(`.vuln_tool_tip`).attr('data-id');
        let card = $(`.vuln_tool_tip`).contents().find(`#vuln-card-${id}`).get(0);

        hideLoading();

        // Reszie the Tooltip
        /**
         * Not Ideal - Multiplying height by 2 avoids rendering glitch, where
         * tooltip cuts off part of the card. Preferablly, this code would execute
         * after card is fully rendered.
         */
        $('.vuln_tool_tip').css({
            'height': (2 * card.offsetHeight) + 'px',
            'width': card.offsetWidth + 'px', 
        });

        showTooltip();
    });

    // Request View of CVE
    $(containerSelect).on('mouseenter', elementSelect, function(e) {
        $('.vuln_tool_tip').attr('data-id', $(this).attr('data-id'));
        let oldSrc = $('.vuln_tool_tip').attr('src');
        let newSrc = `/vulnerabilities/${$(this).attr('data-id')}/card`;

        // Change the Src and Wait for Load 
        if(oldSrc !== newSrc) {
            $('.vuln_tool_tip').contents().find('body').html('');
            hideTooltip();
            showLoading();
            $('.vuln_tool_tip').attr('src', newSrc);
        } else {
            showTooltip();
        }

        $('#tool_tip').css({
            'top': e.pageY + cursorTopOffset,
            'left': e.pageX + cursorLeftOffset
        });
    });

    // Requested View no longer Necessary
    $(containerSelect).on('mouseleave', elementSelect, function(e) {
        hideTooltip();
        hideLoading();
    });

    // Move Tooltip along with Cursor
    $(containerSelect).on('mousemove', elementSelect, function(e) {       
        $('#tool_tip').css({
            'top': e.pageY + cursorTopOffset,
            'left': e.pageX + cursorLeftOffset
        });
    });
}

function hideLoading() {
    $("#tool_tip").find('#loading').css({
        'visibility': 'hidden'
    });
}

function showLoading() {
    $("#tool_tip").find('#loading').css({
        'visibility': 'visible'
    });
}

function hideTooltip() {
    $(`.vuln_tool_tip`).css({
        'visibility': 'hidden'
    });
}

function showTooltip() {
    $(`.vuln_tool_tip`).css({
        'visibility': 'visible'
    });
}
