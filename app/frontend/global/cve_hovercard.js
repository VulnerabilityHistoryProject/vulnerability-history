import $ from 'jquery';
import {vulnTable} from "../vulnerabilities/vulnTable";
import {vulnCards} from "../vulnerabilities/vulnCards";

/**
 * TODO: There is a race condition taking place when rendering the hover card. When the iframe loads it resizes to fit it's content. However,
 * every so often the content adjusts after the iframe has already been resized. I believe this to be an issue regarding how the icons
 * and images in the iframe content are rendered.
 */

/**
 * Set an iframe that is a hover card to load and present the selected vulnerability.
 */
export function setHoverCard() {
    // Hover card offset from Cursor
    var cursorTopOffset = 30;
    var cursorLeftOffset = 30;

    // Permanent Styling Tweaks for Hover Card Loading image.
    $("#cve_hovercard").find('.loading').find('img').css({
        'top': 0,
        'left': 0,
        'margin-left': 0,
        'margin-top': 0
    });
    
    // Render the Hover Card for the new CVE
    $('.cve_hovercard').on('load', function() {
        let id = $(`.cve_hovercard`).attr("data-id"); //not getting it correctly?
        // let card = $(`.cve_hovercard`).contents().find(`#vuln-card-${id}`).get(0);
        let card = document.getElementById("vuln-card-"+id);
        hideLoading();

        // Resize the Hover Card
        /**
         * Not Ideal - Multiplying height by 2 avoids rendering glitch, where
         * hover card cuts off part of the card. Preferably, this code would execute
         * after card is fully rendered.
         */
        $('.cve_hovercard').css({
            'height': (2 * card.offsetHeight) + 'px',
            'width': card.offsetWidth + 'px', 
        });

        debugger
        // $('cve_hovercard').replaceWith(card);
        document.getElementById('cve_hovercard').innerHTML = card.innerHTML;

        showCveHoverCard();
    });

    const hover_list = document.getElementsByClassName("cve_hover_class");
    generateVulnCards(hover_list);
    for(const htmlElement of hover_list){
        // Request View of CVE
        $(htmlElement).on('mouseenter', function(e) {
            $('.cve_hovercard').attr('data-id', htmlElement.id);
            let oldSrc = $('.cve_hovercard').attr('src');
            let newSrc = `/vulnerabilities/${htmlElement.id}/card`;


            // Change the Src and Wait for Load
            if(oldSrc !== newSrc) {
                $('.cve_hovercard').contents().find('body').html('');
                hideCveHoverCard();
                showLoading();
                $('.cve_hovercard').attr('src', newSrc);
            } else {
                showCveHoverCard();
            }

            $('#cve_hovercard').css({
                'top': e.pageY + cursorTopOffset,
                'left': e.pageX + cursorLeftOffset
            });
        });

        // Requested View no longer Necessary
        $(htmlElement).on('mouseleave', function(e) {
            hideCveHoverCard();
            hideLoading();
        });

        // Move Hover Card along with Cursor
        $(htmlElement).on('mousemove', function(e) {
            $('#cve_hovercard').css({
                'top': e.pageY + cursorTopOffset,
                'left': e.pageX + cursorLeftOffset
            });
        });
    }
}

function generateVulnCards(hover_list){
    $.ajax({
        url: '/api/tags',
        dataType: 'json',
    }).then(function (tagMap){ // TODO this gives an array of tags, not a map of them
        //console.log(tagMap)
        for(const htmlElement of hover_list){
            $.ajax({
                url: `/api/${htmlElement.id}`,
                dataType: 'json',
            }).then(function (response){ // TODO doesn't give tag_json
                //console.log(response);
                vulnCards(response, tagMap);
            });
        }
    });
}


function hideLoading() {
    $("#cve_hovercard").find('#loading').css({
        'visibility': 'hidden'
    });
}

function showLoading() {
    $("#cve_hovercard").find('#loading').css({
        'visibility': 'visible'
    });
}

function hideCveHoverCard() {
    $(`#cve_hovercard`).css({
        'visibility': 'hidden'
    });
    document.getElementById("cve_hovercard").style.visibility = "hidden";
}

function showCveHoverCard() {
    $(`#cve_hovercard`).css({
        'visibility': 'visible'
    });
    document.getElementById("cve_hovercard").style.visibility = "visible";
}
