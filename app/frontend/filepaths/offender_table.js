import $ from 'jquery'
import 'datatables.net'
import 'datatables.net-responsive-dt'
import 'datatables.net-zf'
import {hideSinglePagePagination} from 'global/datatablesTweaks'
import {vulnProject, ellipsizedFilepath} from 'global/dataToPrettyStrings'

export function OffenderTable(offenders){

    this.offenders = offenders;
    this.project_id = 0; //project_id 0 is "all" projects

    this.init = function() {
        this.buildTopNav();
        this.registerHandlers();
        this.rebuild(this.offenders);
    }

    this.buildTopNav = function() {
        // $('#datatable_wrapper').prepend('<div id="table-nav-top"></div>');
        // const nav = $('#table-nav-top');
        // nav.addClass('table-nav grid-x');

        // const nav_length = $('#datatable_length');
        // nav_length.addClass('table-nav-show-entries cell small-2')
        // nav.append(nav_length);

        // const nav_search = $('#datatable_filter label');
        // nav_search.addClass('table-nav-search cell small-3')
        // nav.append(nav_search);
    }

    this.languageInfo = function() {
        return {
            search: "", // nothing in the placeholder;
            searchPlaceholder: 'Search',
            lengthMenu: "Show _MENU_",
            info: "Showing _START_ to _END_ of _TOTAL_ offenders",
            infoEmpty: "Showing 0 to 0 of 0 entries",
            infoFiltered: "(filtered from _MAX_ total offenders)",
        };
    }

    this.renderAsLink = function(data, row) {
        return `<a class="dt_row" href="/filepaths/${row.slug}">${data}</a>`;
    }

    this.renderFilepath = function(filepathModel){
        const prefixLen = 15
        const maxLen = 50
        return ellipsizedFilepath(filepathModel.filepath, prefixLen, maxLen)
    }

    this.rebuild = function(jsonData){
        const filtered = jsonData.filter(
            f => (f.project_id == this.project_id || this.project_id == 0)
        );
        $('#datatable').DataTable({
            responsive: true,
            destroy: true,
            autoWidth: false,
            data: filtered,
            order: [[2, "desc"]], /* Default sort */
            preDrawCallback: (settings) => hideSinglePagePagination(settings),
            columns:  [
                {
                    title: 'Project',
                    data: null,
                    defaultContent: '',
                    className: 'project',
                    responsivePriority: 2,
                    width: "8em",
                    render: (data, type, row) => this.renderAsLink(vulnProject(data) + data.project_name, row)
                },
                {
                    title: 'File',
                    data: null,
                    defaultContent: '',
                    className: 'filepath',
                    width: '21em',
                    responsivePriority: 1,
                    render: (data, _type, _row) => this.renderFilepath(data)
                },
                {
                    title: 'Num. Fixes',
                    data: 'num_fixes',
                    defaultContent: '',
                    responsivePriority: 3,
                    render: (data, type, row) => this.renderAsLink(data, row)
                },
                {
                    title: 'Num. CVEs',
                    data: 'num_cves',
                    defaultContent: '',
                    responsivePriority: 4,
                    render: (data, type, row) => this.renderAsLink(data, row)
                },
                {
                    title: 'CVEs',
                    data: 'cves',
                    className: 'cves',
                    defaultContent: '',
                    responsivePriority: 5,
                    render: (data, type, row) => this.renderAsLink(data, row)
                }
            ],
            language: this.languageInfo(),
            initComplete: function () {
                $('#loading').remove();
            }
        });
    }

    this.registerHandlers = function(){
        $('#datatable').on('mouseover', 'tbody tr', function() {
            $(this).css({
                'cursor': 'pointer',
                'color': 'blue'
            });
        })

        $('#datatable').on('mouseout', 'tbody tr', function() {
            $(this).css({
                'cursor': 'default',
                'color': 'inherit'
            });
        })

        $('select.project-choice').on('change', (e) => {
            this.project_id = $(".project-choice option:selected").attr('value');
            this.rebuild(this.offenders);
            // copied from vulnTables for reference
            // this.api().columns(4).every(function() {
            //     var column = this;
            //     $('#tag_filters').on('change', function() {
            //         column.search($(this).val()).draw();
            //         $('.table-nav-more-about-link').hide();
            //         var tag_id = $(this).find(':selected').data('tag-id');
            //         $('#table-nav-tag-' + tag_id).show();
            //     });
        
            //     });
        });
    }

}
