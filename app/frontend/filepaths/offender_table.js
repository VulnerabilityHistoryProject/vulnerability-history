import $ from 'jquery'
import 'datatables.net'
import 'datatables.net-responsive-dt'
import 'datatables.net-zf'
import {hideSinglePagePagination} from 'global/datatablesTweaks'
import {vulnProject} from 'global/dataToPrettyStrings'

export function OffenderTable(offenders){

    this.offenders = offenders;
    this.project_id = 0; //project_id 0 is "all" projects

    this.init = function() {
        this.buildTopNav();
        this.registerHandlers();
        this.rebuild(this.offenders);
    }

    this.buildTopNav = function() {
        $('#datatable_wrapper').prepend('<div id="table-nav-top"></div>');
        const nav = $('#table-nav-top');
        nav.addClass('table-nav grid-x');

        const nav_length = $('#datatable_length');
        nav_length.addClass('table-nav-show-entries cell small-9')
        nav.append(nav_length);

        const nav_search = $('#datatable_filter label');
        nav_search.addClass('table-nav-search cell small-3')
        nav.append(nav_search);
    }

    this.languageInfo = function() {
        return {
            search: "", // nothing in the placeholder;
            searchPlaceholder: 'Search',
            lengthMenu: "Show _MENU_",
            info: "Showing _START_ to _END_ of _TOTAL_ offenders",
            infoEmpty: "Showing 0 to 0 of 0 entries",
            infoFiltered: "(filtered from _MAX_ total offenders)",
        };
    }

    this.renderAsLink = function(data, row) {
        return `<a class="dt_row" href="/filepaths/${row.slug}">${data}</a>`;
    }

    this.rebuild = function(jsonData){
        const filtered = jsonData.filter(
            f => (f.project_id == this.project_id || this.project_id == 0)
        );
        $('#datatable').dataTable({
            responsive: true,
            destroy: true,
            autoWidth: false,
            data: filtered,
            order: [[2, "desc"]], /* Default sort */
            preDrawCallback: (settings) => hideSinglePagePagination(settings),
            columns:  [
                {
                    title: 'Project',
                    data: null,
                    defaultContent: '',
                    className: 'project',
                    responsivePriority: 2,
                    width: "8em",
                    render: (data, type, row) => this.renderAsLink(vulnProject(data) + data.project_name, row)
                },
                {
                    title: 'File path',
                    data: 'filepath',
                    defaultContent: '',
                    className: 'filepath',
                    width: '15em', // will expand to fit long filepaths
                    responsivePriority: 1,
                    render: (data, type, row) => this.renderAsLink(data, row)
                },
                {
                    title: 'Num. Fixes',
                    data: 'num_fixes',
                    defaultContent: '',
                    responsivePriority: 3,
                    render: (data, type, row) => this.renderAsLink(data, row)
                },
                {
                    title: 'Num. CVEs',
                    data: 'num_cves',
                    defaultContent: '',
                    responsivePriority: 4,
                    render: (data, type, row) => this.renderAsLink(data, row)
                },
                {
                    title: 'CVEs',
                    data: 'cves',
                    className: 'cves',
                    defaultContent: '',
                    responsivePriority: 5,
                    render: (data, type, row) => this.renderAsLink(data, row)
                }
            ],
            language: this.languageInfo(),
            initComplete: function () {
                $('#loading').remove();
            }
        });
    }

    this.registerHandlers = function(){
        $('#datatable').on('mouseover', 'tbody tr', function() {
            $(this).css({
                'cursor': 'pointer',
                'color': 'blue'
            });
        })

        $('#datatable').on('mouseout', 'tbody tr', function() {
            $(this).css({
                'cursor': 'default',
                'color': 'inherit'
            });
        })

        $('select.project-choice-table').change((e) => {
            this.project_id = $("select.project-choice-table option:selected")
                .attr('value');
            this.rebuild(this.offenders);
        });
    }

}
