<p id="notice"><%= notice %></p>

<%= render('shared/title') do %>
  Known Offenders
<% end %>

<%= render('shared/grid', size: 6) do %>
<p>
  A <b>known offender</b> is a file that has been fixed for a vulnerabilty at any point in history.
</p>
<p class="text-center">
  Click on the visual to zoom in. Click on the path to learn more about the file.
</p>
<% end %>

<style>
svg {
  font: 10px sans-serif;
  border: 1px solid #ccc;
}
</style>

<%= render('shared/grid', size: 10) do %>
  <div id="offenders_sequence">&nbsp;</div>
  <div id="offenders_map"></div>
<% end %>

<script>

// Should we display this file?
// We can use this to limit the great-great-*-grandchildren
// Don't show root
function display_rule(d) {
  // if (d.depth == 0) {
  //   return "none"; // don't show root node
  // }
  // else if (d.depth > 4) {
  //   return "none";
  // }
  // else {
    return null; // show everything else
  // }
}



$.ajax({
  url: "/api/filepaths?offenders=true",
  dataType: 'json',
  success: function(jsonData) {
    // Generate parent directories
    jsonData['/'] = ''; // root directory
    for (filepath in jsonData) {
      current = filepath;
      while(current.indexOf('/') > 0) {
        current = current.substring(0, current.lastIndexOf('/'));
        jsonData[current] = jsonData[current] || ''; // Ruby ||=
      }
    }
    // Convert from hash to array of hashes
    arrayData = [];
    for (filepath in jsonData) {
      arrayData.push({
        'filepath' : filepath,
        'num' : jsonData[filepath]
      });
    }
    //Sort the data
    arrayData.sort(function(a,b){
      return (a.filepath > b.filepath) ? 1 : ((b.filepath > a.filepath) ? -1 : 0);
    });

    var stratify = d3.stratify()
      .parentId(function (d) {
        if(d.filepath == '/') return null;
        if(d.filepath.indexOf('/') > 0) { // non-root file
          return d.filepath.substring(0, d.filepath.lastIndexOf('/'));
        } else { //root file
          return '/';
        }
      })
      .id(function (d) {
        return d.filepath;
      });

    root = stratify(arrayData);

    root.sum(function(d) { return d.num });
    console.log(root)

    //Init SVG
    var width = 960,
        height = 700,
        radius = Math.min(width, height) / 2;

    var svg = d3.select("#offenders_map").append("svg:svg")
      .attr("width", width)
      .attr("height", height)
    var g = svg.append('g')
        .attr('transform', 'translate(' + width / 2 + ',' + height / 2 + ')');

    // Init scales for zooming
    var x = d3.scaleLinear()
      .range([0, 2 * Math.PI]);

    var y = d3.scaleSqrt()
      .range([0, radius]);

    //Size the arcs
    var partition = d3.partition()
    // .size([2 * Math.PI, radius]);
    partition(root)
    var arc = d3.arc()
      .startAngle(function(d) { return Math.max(0, Math.min(2 * Math.PI, x(d.x0))); })
      .endAngle(function(d) { return Math.max(0, Math.min(2 * Math.PI, x(d.x1))); })
      .innerRadius(function(d) { return Math.max(0, y(d.y0)); })
      .outerRadius(function(d) { return Math.max(0, y(d.y1)); });

    // Create color scheme
    var color = d3.scaleOrdinal(d3.schemeCategory20b);

    // Put it all together
    g.selectAll('path')
      .data(root.descendants())
      .enter().append('path')
      .attr("display", display_rule)
      .attr("d", arc)
      .attr("class", "feature")
      .style('stroke', '#ccc')
      .style("fill", function (d) { return color((d.children ? d : d.parent).data.name); })
      .on("click", clicked)
      .on("mouseover", mouseover)
      ;

    // When we click on a particular path, we zoom in
    function clicked(d) {
      svg.transition()
        .duration(750)
        .tween("scale", function() {
          var xd = d3.interpolate(x.domain(), [d.x0, d.x1]),
              yd = d3.interpolate(y.domain(), [d.y0, 1]),
              yr = d3.interpolate(y.range(), [d.y0 ? 20 : 0, radius]);
          return function(t) { x.domain(xd(t)); y.domain(yd(t)).range(yr(t)); };
        })
      .selectAll("path")
        .attrTween("d", function(d) { return function() { return arc(d); }; });
    }

    function mouseover(d){
      // f = JSON.parse(d.data.filepath);
      f = d.data.filepath;
      d3.select("#offenders_sequence").html(f);
    }
  }
});


</script>

<!-- <%= @filepaths.to_a %> -->

<!-- <%= render 'shared/loading' =%>

<table id="datatable" class="display" width="100%">
  <thead></thead>
  <tbody></tbody>
  <tfoot></tfoot>
</table>

<%= javascript_include_tag "filepaths/index" %> -->
