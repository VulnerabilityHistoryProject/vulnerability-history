require 'coderay'
require 'yaml'
require 'kramdown'
require 'rinku'
require 'active_support'

module ApplicationHelper

  # VHP-Flavored Markdown
  #
  #  * Markdown syntax
  #  * URLs are auto-converted to an <a> tag
  #  * CVE identifiers link to the CVE database
  #  * Icons inside of colons get converted to <i> tags.
  #  * Sanitize goes over the HTML code to remove anything XSS-related
  #  * Declare the HTML to be safe
  #
  def markdown(source)
    warn 'DEPRECATED. Ruby-side VHP-flavored Markdown is SLOOOOOW! Use client-side JS instead.'
  end

  # Simplifies the CWE name if it has a nickname in parentheses function
  # Mirrored implementation: /app/assets/javascripts/global/vulnCards.js
  # Examples:
  #   "I do not want this ('I want this') not this" --> "I want this"
  #   "Just a string" --> "Just a string"
  def friendly_cwe(name)
    match = name.match(/.*\(\'(.+)\'\).*/);
    # [0] is the full string, [1] is the actual match
    return match.nil? ? name : match[1]
  end

  def pretty_code(str)
    # the [3..-1] removes the YAML front matter, "---\n"
    CodeRay.scan(str.to_yaml[3..-1], :yaml).
            div(:line_numbers => :table)
  end

  def pretty_date(source)
    source.strftime('%a %d %b %Y')
  end

  def current_page(path)
    'current' if request.url.split('/').last == path.split('/')[1]
  end

  def current_page_path()
    if request.env['PATH_INFO'] == "/"
    "home"
  else 
    request.env['PATH_INFO'].split("/").last
  end
    
  end

  # Generate the page title based on what was provided in view page
  def generate_title(str)
    if str.blank?
      "The Vulnerability History Project"
    else
      str = sanitize_title(str)
      "#{str} | Vulnerability History Project"
    end
  end

  # Replaces HTML character codes with proper char
  # Table for these codes can be found at https://www.rapidtables.com/web/html/html-codes.html
  def sanitize_title(str)
    special_chars = {"&#33;": "!", "&#34;": '"', "&#35;": "#", "&#37;": "%", "&#38;": "&", "&#39;": "'", "&#44;": ",",
                          "&#45;": "-", "&#46;": ".", "&#47;": "/", "&#63;": "?"}
    special_chars.each do |html_code, char|
      str = str.gsub(html_code.to_s, char)  # Replaces HTML character
    end
    str
  end
end
