require 'json'
require_relative 'base_loader'

class GitLoader extend BaseLoader
  def load_data(repo_path)
    File.open("#{repo_path}/commits/gitlog.json") do |f|
      get_commits(f)
    end
  end

  private

  def get_commits(file)
    json_file = File.read(file)
    data_hash = JSON.parse(json_file)
    data_hash.each do |hash|
      add_to_db(hash)
    end
  end

  def add_to_db(hash)
    dev = Developer.new
    email = Developer.sanitize_validate_email hash["email"]
    dev.email = email
    dev.save

    commit = Commit.new
    commit.commit_hash = hash["commit"]
    commit.author_id = Developer.find_by_email(email).id
    commit.message = hash["message"]
    commit.date_created = hash["date"]
    commit.notes = ""
    commit.save

    hash["filepaths"].each do |path, churn|
      fp = Filepath.new
      fp.filepath = path
      fp.notes = ""
      fp.save

      commit_filepath = CommitFilepath.new
      commit_filepath.filepath_id = (Filepath.find_by filepath: path).id
      commit_filepath.commit_id = (Commit.find_by commit_hash: hash[:commit_hash]).id
      commit_filepath.total_churn = churn
      commit_filepath.save
      Event.create(detail: commit_filepath)
    end
  end
end
