class VulnerabilityLoader
  def load_data(repo_path)
    Dir["#{repo_path}/cves/*.yml"].each do |file|
      begin
        yml = File.open(file) { |f| YAML.load(f) }
        v   = create_vulnerability(yml)
        create_fixes(v, yml) unless v.nil?
        create_vccs(v, yml) unless v.nil?
        create_interesting_commits(yml)
      rescue => e
        $stderr.puts "Error loading vuln file #{file}. Cause:"
        raise e
      end
    end
  end

  def create_vulnerability(yml)
    if yml["announced"].nil?
      puts "ANNOUNCED DATE MISSING for #{yml['CVE']}"
    else
      Vulnerability.create!(
        cve: yml["CVE"],
        announced: yml["announced"],
        description: yml["description"].to_s,
        upvotes: yml["upvotes"].to_i,
        notes: yml.except('cve'),
      )
    end
  end

  def create_fixes(v, yml)
    yml['fixes']&.each do | entry |
      hash = entry['commit'] || entry[:commit]
      commit = Commit.find_by(commit_hash: hash)
      if commit.nil?
        # puts "WARNING: Missing commit data for #{hash}. Fix not created."
      else
        Fix.create!(
          vulnerability: v,
          commit: commit,
          notes: { note: entry['note'] } ,
        )
      end
    end
  end

  def create_vccs(v, yml)
    yml['vccs']&.each do | entry |
      hash = entry['commit'] || entry[:commit]
      commit = Commit.find_by(commit_hash: hash)
      if commit.nil?
        # puts "WARNING: Missing commit data for #{hash}. Fix not created."
      else
        Vcc.create!(
          vulnerability: v,
          commit: commit,
          notes: { note: entry['note'] } ,
        )
      end
    end
  end

  def create_interesting_commits(yml)
    yml['interesting_commits']['commits']&.each do | entry |
      hash = entry['commit'] || entry[:commit]
      commit = Commit.find_by(commit_hash: hash)
      if commit.nil?
        # puts "WARNING: Missing commit data for #{hash}. Fix not created."
      else
        Vcc.create!(
            commit: commit,
            note: entry['note'],
            )
      end
    end
  end

end
