require 'git'
require 'yaml'
require 'fileutils'
require 'find'
require 'timing_logger'
require_all 'lib/event_generators/*.rb'
require_all 'lib/loaders/*.rb'
require_all 'lib/taggers/*.rb'

logger = TimingLogger.new(STDOUT, 'data:struts')

desc 'Clean rebuild of HTTPD data.'
namespace :data do
  task :struts => [
    'environment',
    'data:struts:check_exist',
    'data:struts:github_clone',
    'data:struts:load',
    'data:struts:tags',
    'data:struts:events',
    'data:optimize',
    'data:clear_cache',
  ]

  namespace :struts do
    repo_name = 'struts-vulnerabilities'
    repo_dir = "./tmp/checkout/" + repo_name
    git_branch = 'master'

    desc 'Check if HTTPD data has been loaded'
    task :check_exist => :environment do
      if Project.exists? subdomain: 'struts'
        puts "\n\nWARNING: HTTPD data already loaded. Run data:clear first. Expect uniqueness violations.\n\n\n"
      end
    end

    desc 'Re-load, but skip cloning from GitHub'
    task :nogit => [
      'environment',
      'data:struts:load',
      'data:struts:events',
      'data:struts:tags',
      'data:optimize',
    ]

    desc 'Pull data from GitHub'
    task :github_clone do
      logger.info "Removing git #{repo_dir}..."
      FileUtils.rm_rf repo_dir if (File.exist?(repo_dir))
      logger.info "Cloning repo from GitHub on #{git_branch}..."
      g = Git.clone(
        'git://github.com/VulnerabilityHistoryProject/struts-vulnerabilities.git',
        repo_name,
        path: './tmp/checkout',
        branch: git_branch,
        depth: 1
      )
      logger.info "Loaded data version: #{g.object('HEAD').sha[0..10]}"
    end

    desc 'Load base data into db'
    task :load => :environment do
      ProjectLoader.new.load_data(repo_dir)
      project = Project.find_by(subdomain: 'struts')
      [
        GitLoader,
        CodeNoteLoader,
        ReleaseLoader,
        VulnerabilityLoader,
      ].each do |loader|
        logger.info "Running #{loader}..."
        loader.new.load_data(repo_dir, project)
      end
    end

    desc 'Generate event models'
    task :events => :environment do
      project = Project.find_by(subdomain: 'struts')
      [
        SimilarEvents,
        VulnerabilityEvents,
        FixEvents,
        VccEvents,
        # ReleaseEvents,
        BountyEvents,
      ].each do |generator|
        logger.info "Generating #{generator.to_s.tableize.humanize.downcase}"
        generator.new(project).generate
      end
      logger.info "Generating weekly report events and tags"
      WeeklyReportEvents.new.generate(repo_dir)
    end

    desc 'Generate and apply tags'
    task :tags => :environment do
      project = Project.find_by(subdomain: 'struts')
      [
        LifetimeTagger,
        BountyTagger,
        DEPSTagger,
        ErrorOfOmissionTagger,
        CWETagger,
        CVSSTagger,
        DiscoveryTagger,
        ErrorOfOmissionTagger,
        LanguageTagger,
        LessonsTagger,
        SubsystemTagger,
        UnitTestTagger
      ].each do |tagger|
        logger.info "Tagging with #{tagger}"
        t = tagger.new(project)
        t.create_tags
        t.apply_tags
      end
      orig = OriginTagger.new(project)
      orig.create_tags
      orig.apply_tags(repo_dir)

      project = Project.find_by(subdomain: 'struts')
      project_tagger = ProjectTagger.new(repo_dir, project)
      project_tagger.create_tags
      project_tagger.apply_tags

    end

  end
end
