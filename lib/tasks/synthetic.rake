desc 'Generate tons of synthetic data'
namespace 'data' do
  task :synthetic => :environment do
    Style.create(event_type: 'vulnerability', color: '#ED6049', icon: 'bug_report')
    Style.create(event_type: 'fix', color: '#6FD56E', icon: 'build')
    Style.create(event_type: 'vcc', color: '#F3A23A', icon: 'open_in_browser')
    Style.create(event_type: 'release', color: '#D270CA', icon: 'bookmark')
    Style.create(event_type: 'commit', color: '#6AA5E5', icon: 'mode_edit')

    notes = {
      bounty_title: 'Bounty awarded',
      bounty: 21337.0,
      bounty_announced: '1984-05-19',
    }

    prng = Random.new(1234)
    100.times do |i|
      notes["something_#{i}"] = prng.rand(32.years).seconds.ago
    end
    v = Vulnerability.create!(
      cve: 'CVE-1984-0519',
      announced: '2013-03-02'.to_datetime,
      notes: notes
    )
    dev = Developer.find_or_create_by!(email: 'example@example.com')
    file = Filepath.find_or_create_by!(filepath: 'vhp_synthetic_data.c')
    fix_commit = Commit.find_or_create_by(
      date_created: prng.rand(32.years).seconds.ago,
      author_id: dev.id,
      commit_hash: prng.rand.to_s,
      message: "Fix for synthetic vulnerability CVE-1984-0519.",
    )
    # byebug
    CommitFilepath.find_or_create_by!(
      commit: fix_commit,
      filepath: file,
    )
    Fix.find_or_create_by!(
      commit: fix_commit,
      vulnerability: v,
    )

    Event.create(detail: v, type_template: 'bounty')

    100.times do | i |
      # Event.create(
      #   detail: v,
    #   title_template: "The #{i.ordinalize} event for :title:",
      #   description_template: 'This is a description of :title:.'
      # )
      commit = Commit.create(
        date_created: prng.rand(32.years).seconds.ago,
        author_id: dev.id,
        commit_hash: prng.rand.to_s,
        message: "Synthetic commit message with a random number. #{prng.rand}. Done.",
      )
      commit.filepaths << file
      Event.create(
        detail_id: commit.id,
        detail_type: 'Commit',
        title_template: 'Edit: :title:',
        description_template: <<-EOS
        Vulnerable code was edited. Here was the commit message.

        :description:
      EOS
      )
    end
    puts "Synthetic data loaded for CVE-1984-0519"
  end
end
