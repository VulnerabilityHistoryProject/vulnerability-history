desc 'Generate tons of synthetic data'
namespace 'data' do
  task :synthetic => :environment do
    vuln_style    = Style.find_or_create_by!(color: '#ED6049', icon: 'bug_report', name: 'vulnerability')
    fix_style     = Style.find_or_create_by!(color: '#6FD56E', icon: 'build', name: 'fix')
    vcc_style     = Style.find_or_create_by!(color: '#F3A23A', icon: 'open_in_browser', name: 'vcc')
    release_style = Style.find_or_create_by!(color: '#D270CA', icon: 'bookmark', name: 'release')
    commit_style  = Style.find_or_create_by!(color: '#6AA5E5', icon: 'mode_edit', name: 'commit')

    notes = {
      bounty_title: 'Bounty awarded',
      bounty: 21337.0,
      bounty_announced: '1984-05-19',
    }
    prng = Random.new(1234)
    100.times do |i|
      notes["something_#{i}"] = prng.rand(32.years).seconds.ago
    end
    v = Vulnerability.create!(
      cve: 'CVE-1984-0519',
      announced: '2013-03-02'.to_datetime,
      description: 'This is a synthetically generated vulnerability.',
      notes: notes
    )
    dev = Developer.find_or_create_by!(email: 'example@example.com')
    file = Filepath.find_or_create_by!(filepath: 'vhp_synthetic_data.c')
    fix_commit = Commit.find_or_create_by!(
      date_created: prng.rand(32.years).seconds.ago,
      author_id: dev.id,
      commit_hash: prng.rand.to_s,
      message: "Fix for synthetic vulnerability CVE-1984-0519.",
    )
    CommitFilepath.find_or_create_by!(
      commit: fix_commit,
      filepath: file,
    )
    fix = Fix.find_or_create_by!(
      commit: fix_commit,
      vulnerability: v,
    )

    10.times do |i|
      Event.create!(
        detail: fix,
        type_template: 'bounty',
        date_template: prng.rand(32.years).seconds.ago,
        style: fix_style
      )
    end

    Event.create!(
      detail: v,
      type_template: 'vulnerability',
      style: vuln_style
    )

    commit = Commit.create!(
      date_created: '2011-03-09',
      author_id: dev.id,
      commit_hash: prng.rand.to_s,
      message: "Synthetic commit message for testing Issue 183,184.",
    )
    commit.filepaths << file
    20.times do |i|
      Event.create!(
      detail_id: commit.id,
      detail_type: 'Commit',
      style: commit_style,
      title_template: 'Edit: :title:',
      description_template: <<-EOS
      Vulnerable code was edited. Here was the commit message.

      :description:
    EOS
      )
    end

    200.times do | i |
      commit = Commit.create!(
        date_created: prng.rand(32.years).seconds.ago,
        author_id: dev.id,
        commit_hash: prng.rand.to_s,
        message: "Synthetic commit message with a random number. #{prng.rand}. Done.",
      )
      commit.filepaths << file
      Event.create!(
        detail_id: commit.id,
        detail_type: 'Commit',
        style: commit_style,
        title_template: 'Edit: :title:',
        description_template: <<-EOS
        Vulnerable code was edited. Here was the commit message.

        :description:
      EOS
      )
    end
    puts "Synthetic data loaded for CVE-1984-0519"
  end
end
