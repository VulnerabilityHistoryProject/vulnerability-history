########################################
# Releases and Vulnerability Functions #
########################################
def releaseData(parsed, projectName)
    parsed["releases"].each do |key, date|
      releases = Release.new
      releases.number = key
      releases.date = date
      releases.project = projectName
      releases.save
    end
end

def vulnerabilityData(vuln_data)
  cve = vuln_data["CVE"]
  fixes = vuln_data["fixes"]
  vccs = vuln_data["vccs"]

  #vuln_data table
  vuln = Vulnerability.new
  vuln.cve = cve
  vuln.notes = vuln_data.except("cve")
  vuln.save

  vuln_id = vuln.id
  add_vuln_data_to_db(fixes, vuln_id, Fix)
  add_vuln_data_to_db(vccs, vuln_id, Vcc)
end

def add_vuln_data_to_db(data, vuln_id, type)
  unless data.nil?
    data.each do |entry|
      case entry
      when Hash
        entry.each do |hash, message|
          d = type.new
          d.vulnerability_id = vuln_id
          d.commit_id = (Commit.find_by commit_hash: hash).id
          d.notes = message["note"]
          d.save

          Event.create(detail: d)
        end
      when String
        d = type.new
        d.commit_id = (Commit.find_by commit_hash: entry).id
        d.vulnerability_id = vuln_id
        d.notes = ""
        d.save

        Event.create(detail: d)
      end
    end
  end
end
