require 'data_builder'

namespace :data do

  'Rebuild all data from all projects'
  task :all => %w(
    environment
    data:no_logger
    data:writing:github_clone
    data:clear
    data:build
    data:writing
    data:optimize
    data:clear_cache
    data:done
  )

  'Rebuild all data from all projects FROM DEV BRANCH'
  task :dev_all => %w(
    data:set_dev_data_env
    data:all
  )

  task 'Check that the curated YMLs load on their own'
  task :check_yml_loads => %w(
    environment
    data:no_logger
    data:clear
    data:build_vulns_only
    data:done
  )

  desc 'Disable AR logging, for performance'
  task :no_logger => :environment do
    ActiveRecord::Base.logger = nil
  end

  desc 'Build all vulnerabilities data'
  task :build do
    builder = DataBuilder.new
    builder.check_exist        # has the data already been loaded?
    builder.clone_vuln_repo    # clone from github
    builder.clone_mining_repo  # clone from github
    builder.save_web_version   # save web version metadata
    builder.load_data          # load cve ymls
    builder.generate_events    # generate events
    builder.generate_tags      # generate tags
  end

  desc 'Build data from curation YMLs, ignoring other builds'
  task :build_vulns_only do
    builder = DataBuilder.new
    builder.check_exist      # has the data already been loaded?
    builder.clone_vuln_repo    # clone from github
    builder.load_vulns_only  # load cve ymls only
  end

  desc 'Set VHP_DATA_BRANCH=dev env var. Does nothing else! Run rails data:dev_all instead'
  task :set_dev_data_env do
    ENV['VHP_DATA_BRANCH'] = 'dev'
  end

end

desc 'Clean rebuild of ALL data: Chromium, HTTPD'
namespace :data do

  desc 'Show some basic stats when the build is done'
  task :done => :environment do
    logger = TimingLogger.new(STDOUT, 'data:done')
    logger.info "#{Vulnerability.count} vulnerabilities"
    logger.info "#{Event.count} events"
    logger.info "#{Tag.count} tags"
    logger.info "#{Developer.count} developers"
    logger.info "#{Article.count} articles"
    logger.info "#{Filepath.count} filepaths"
    logger.done
  end

end