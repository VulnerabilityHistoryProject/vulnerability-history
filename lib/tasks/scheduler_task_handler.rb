########################################
# Event Handler Functions #
########################################
require_relative 'scheduler_gitlog_methods'
require 'find'
require 'fileutils'
require 'yaml'
require 'git'

class Scheduler_Task_Handler
    def self.cloneGitRepo(findAddress, gitAddress, gitName, gitBranch)
      puts "Removing git folders..."
      FileUtils.rm_rf findAddress if (File.exist?(findAddress))
      puts "Cloning repo from GitHub..."
      g = Git.clone(gitAddress,
                    gitName,
                    path: './tmp/checkout',
                    branch: gitBranch)
    end

    def self.yamlGitLogHandling(findAddress)
        vuln_ymls    = []
        release_ymls = []
        git_logs     = []
        #Finds all the YAML files and gitlogs
        puts "Finding YAML and GitLog..."
        Find.find(findAddress) do |path|
            vuln_ymls   << path if path =~ /CVE.*\.yml$/
            release_ymls << path if path =~ /releases.yml$/
            git_logs     << path if path =~ /gitlog*\.txt$/
        end
        return git_logs, vuln_ymls, release_ymls
    end

    def self.gitParsing(git_logs)
        #parses through git logs
        puts "Parsing through git logs..."
        for git_log in git_logs
            f = File.open(git_log)
            GitLog_CVE_Methods.get_commits(f)
            f.close
        end
    end

end
