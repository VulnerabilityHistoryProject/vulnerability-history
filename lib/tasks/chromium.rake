require 'git'
require 'yaml'
require 'fileutils'
require 'find'
require 'git'
require 'event_generators/bounty_events'
require 'event_generators/commit_events'
require 'event_generators/fix_events'
require 'event_generators/release_events'
require 'event_generators/vcc_events'
require 'event_generators/vulnerability_events'
require 'loaders/release_loader'
require 'loaders/git_loader'
require 'loaders/vulnerability_loader'
require 'taggers/bounty_tagger'

desc 'Clean rebuild of Chromium data.'
namespace :data do
  task :chromium => [
    'environment',
    'data:clear',
    'data:chromium:github_clone',
    'data:chromium:load',
    'data:chromium:events',
    'data:chromium:tags',
  ]

  namespace :chromium do
    gitName = 'chromium-vulnerabilities'
    findAddress = "./tmp/checkout/" + gitName
    gitAddress = 'https://github.com/andymeneely/chromium-vulnerabilities.git'
    gitBranch = 'issue_163' #remember to change before pushing to master
    customEvent = "bounty"
    projectName = 'Chromium'

    desc 'Re-load, but skip cloning from GitHub'
    task :nogit => [
      'environment',
      'data:clear',
      'data:chromium:load',
      'data:chromium:events',
      'data:chromium:tags',
    ]

    desc 'Pull data from GitHub'
    task :github_clone do
      puts "Removing git folders..."
      FileUtils.rm_rf findAddress if (File.exist?(findAddress))
      puts "Cloning repo from GitHub..."
      g = Git.clone(gitAddress,
                    gitName,
                    path: './tmp/checkout',
                    branch: gitBranch)
    end

    desc 'Load base data into db'
    task :load => :environment do
      [
        GitLoader,
        ReleaseLoader,
        VulnerabilityLoader,
      ].each do |loader|
        puts "Running #{loader}..."
        loader.new.load_data(findAddress)
      end
    end

    desc 'Generate event models'
    task :events => :environment do
      [
        VulnerabilityEvents,
        FixEvents,
        VccEvents,
        ReleaseEvents,
        CommitEvents,
        BountyEvents,
      ].each do |generator|
        puts "Generating #{generator.to_s.tableize.humanize.downcase}"
        generator.new.generate
      end
    end

    desc 'Generate and apply tags'
    task :tags => :environment do
      [
        BountyTagger,
      ].each do |tagger|
        puts "Tagging with #{tagger}"
        t = tagger.new
        t.create_tags
        t.apply_tags
      end
    end
  end

end
