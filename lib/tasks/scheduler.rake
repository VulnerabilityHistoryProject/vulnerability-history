desc "This task is called by the Heroku scheduler add-on. It also will download a git repo to a directory in tmp/checkout. Put in lib/tasks"
require 'git'
require 'find'
require 'yaml'
require 'fileutils'
require_relative 'scheduler_methods'

gitAddress = 'https://github.com/andymeneely/chromium-vulnerabilities.git'
gitName = 'chromium-vulnerabilities'
projectName = 'Chromium'
task :clone_git => :environment do
  g = Git.clone(gitAddress, gitName, :path => './tmp/checkout')
  findAddress = "./tmp/checkout/" + gitName
  ymlFiles = []
  parsed = []
  Find.find(findAddress) do |path|
    ymlFiles << path if path=~ /.*\.yml$/
  end
  for name in ymlFiles
    parsedItem = begin
      YAML.load(File.open(name))
    rescue ArgumentError => e
      puts "Could not parse YAML: #{e.message}"
    end
    parsed.push(parsedItem)
  end
  
  parsed.each do |parsedToSave|
    if (parsedToSave.keys[0] == "releases")
      releaseData(parsedToSave, projectName)
    else
      puts parsedToSave
      vulnerabilityData(parsedToSave)
      fixesData(parsedToSave)
      fileData(parsedToSave)
    end
  end
  FileUtils.rm_r findAddress
end

#Function Calls
def releaseData(parsed, projectName)
    parsed["releases"].each do |key, date|
      releases = Release.new
      releases.number = key
      releases.date = date
      releases.project = projectName
      releases.save
    end
end

