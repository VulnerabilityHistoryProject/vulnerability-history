desc "This task is called by the Heroku scheduler add-on. It also will download a git repo to a directory in tmp/checkout. Put in lib/tasks"
require 'git'
require 'yaml'
require 'fileutils'
require 'event_generators/commit_events'
require_relative 'scheduler_task_handler'

gitAddress = 'https://github.com/andymeneely/chromium-vulnerabilities.git'
gitName = 'chromium-vulnerabilities'
gitBranch = 'master'
customEvent = "bounty"
projectName = 'Chromium'

task :clone_git => :environment do
  findAddress = "./tmp/checkout/" + gitName
  puts "Clearing database..."
  Rake::Task['db:schema:load'].invoke

  Scheduler_Task_Handler.cloneGitRepo(findAddress, gitAddress, gitName, gitBranch)
  git_logs, ymlFiles = Scheduler_Task_Handler.yamlGitLogHandling(findAddress)
  Scheduler_Task_Handler.gitParsing(git_logs)
  parsedYAMLFiles = Scheduler_Task_Handler.yamlParsing(ymlFiles)
  Scheduler_Task_Handler.cveMethods(parsedYAMLFiles, customEvent, projectName)
  Scheduler_Task_Handler.gitMethods()

end
