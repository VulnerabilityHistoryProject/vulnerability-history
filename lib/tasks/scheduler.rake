desc "This task is called by the Heroku scheduler add-on. It also will download a git repo to a directory. Put in lib/tasks"
require 'git'
require 'find'
require 'yaml'

gitAddress = 'https://github.com/andymeneely/chromium-vulnerabilities.git'
gitName = 'chromium-vulnerabilities'
task :cloneGit => :environment do
    g = Git.clone(gitAddress, gitName, :path => './tmp/checkout')
    
    ymlFiles = []
    parsed = []
    Find.find('./tmp/checkout/chromium-vulnerabilities/') do |path|
        ymlFiles << path if path=~ /.*\.yml$/
    end
    puts ymlFiles
    for name in ymlFiles
        parsedItem = begin
            YAML.load(File.open(name))
        rescue ArgumentError => e
            puts "Could not parse YAML: #{e.message}"
        end
        puts parsedItem
        parsed.push(parsedItem)
    end
     parsed.each do |parsedToSave|
         if (parsedToSave.keys[0] == "releases")
             parsedToSave["releases"].each do |key, date|
                 releases = Release.new
                 releases.number = key
                 releases.date = date
                 releases.project = "Chromium"
                 releases.save
            end
             
         else
            cve = parsedToSave.keys[0]
            #vulnerabilities table
            vulnerabilities = Vulnerability.new
            vulnerabilities.CVE = cve
            vulnerabilities.bounty = parsedToSave[cve]["bounty"]
            vulnerabilities.announced = parsedToSave[cve]["announced"]["date"]
            vulnerabilities.url = parsedToSave[cve]["announced"]["url"]
            vulnerabilities.code_reviews = parsedToSave[cve]["code_reviews"]
            vulnerabilities.bugs = parsedToSave[cve]["bugs"]
            vulnerabilities.save
             
             #Fixes Table
             fixesArray = parsedToSave[cve]["fixes"]
=begin
             fixesArray.each do |fix|
                fixes = Fix.new
                fixes.vulnerability_name = cve
                fixes.fix_num = parsedToSave[cve]["fixes"]
                fixes.save
             end
=end
             
             
             arrayFiles = parsedToSave[cve]["files"].keys
             #for every file look at vccs 
             #Source File 
             arrayFiles.each do |fileArray|
                 #source_files = Filepath.new
                 #source_files.vulnerability_name = cve
                 #puts source_files.filepath = fileArray
                 #source_files.note = parsedToSave[cve]["files"][fileArray]["note"]
                 
                 #keyVccs = parsedToSave[cve]["files"][fileArray]["vccs"][0].keys[0]
                 
                 #source_files.vccs =  keyVccs
                 
                 #source_files.vccs_note =  parsedToSave[cve]["files"][fileArray]["vccs"][0][keyVccs]["note"]
                 
                 
                 #keyVccs = parsedToSave[cve]["files"][fileArray]["vccs"][1].keys[0]
                 
                 #source_files.vccs2 =  keyVccs
                 
                 #source_files.vccs_note2 =  parsedToSave[cve]["files"][fileArray]["vccs"][1][keyVccs]["note"]
                 #source_files.save
             end
            
         end
    end
    #rails db:setup
    
end