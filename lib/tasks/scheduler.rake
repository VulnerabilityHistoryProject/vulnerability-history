desc "This task is called by the Heroku scheduler add-on. It also will download a git repo to a directory in tmp/checkout. Put in lib/tasks"
require 'git'
require 'find'
require 'yaml'
require 'fileutils'
require_relative 'scheduler_methods'

gitAddress = 'https://github.com/andymeneely/chromium-vulnerabilities.git'
gitName = 'chromium-vulnerabilities'
projectName = 'Chromium'
task :clone_git => :environment do
  findAddress = "./tmp/checkout/" + gitName
  if (File.exist?(findAddress))
      FileUtils.rm_r findAddress
  end
  g = Git.clone(gitAddress, gitName, :path => './tmp/checkout')
  ymlFiles = []
  parsedYAMLFiles = []
  git_logs = []
  Find.find(findAddress) do |path|
    ymlFiles << path if path=~ /CVE.*\.yml$/
    git_logs << path if path=~ /gitlog*\.txt$/
  end
  for name in ymlFiles
    parsedItem = begin
      YAML.load(File.open(name))
    rescue ArgumentError => e
      puts "Could not parse YAML: #{e.message}"
    end
    parsedYAMLFiles.push(parsedItem)
  end

  parsedYAMLFiles.each do |parsedToSave|
    if (parsedToSave.keys[0] == "releases")
      releaseData(parsedToSave, projectName)
    else
      if !(Vulnerability.exists?(:cve=>parsedToSave["CVE"]))
        vulnerabilityData(parsedToSave)
      end
    end
  end
  for git_log in git_logs
    get_commits(File.open(git_log))
  end
end
