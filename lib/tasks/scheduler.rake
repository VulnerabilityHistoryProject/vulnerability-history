desc "This task is called by the Heroku scheduler add-on. It also will download a git repo to a directory. Put in lib/tasks"
require 'git'
require 'find'
require 'yaml'
task :cloneGit => :environment do
g = Git.clone('https://github.com/andymeneely/chromium-vulnerabilities.git', 'chromium-vulnerabilities', :path => './tmp/checkout')
    ymlFiles = []
    parsed = []
    Find.find('./tmp/checkout/chromium-vulnerabilities/cves') do |path|
        ymlFiles << path if path=~ /.*\.yml$/
    end
    puts ymlFiles
    for name in ymlFiles
        parsedItem = begin
            YAML.load(File.open(name))
        rescue ArgumentError => e
            puts "Could not parse YAML: #{e.message}"
        end
        parsed.push(parsedItem)
    end
    #puts parsed
    #puts parsed.keys[0]
    #parsed.each do |parsedToSave|
    #    puts parsedToSave.keys[0]
    #    puts parsedToSave
    #    puts ""
        #puts parsedToSave.key("bounty")
        #puts "try"
        #puts parsedToSave["CVE-2011-3092"]["files"]["webkit/port/DerivedSources.make"]["vccs"]["4bab3b214e92e0884af87c4ae9287da3daff5f3d"]
        #puts parsedToSave.key("$1000.00")
    #end
    #["webkit/port/DerivedSources.make"]["vccs"]["4bab3b214e92e0884af87c4ae9287da3daff5f3d"]["note"]
    parsed.each do |parsedToSave|
        cve = parsedToSave.keys[0]
        vulnerabilities = Vulnerability.new
        vulnerabilities.CVE = cve
        vulnerabilities.bounty = parsedToSave[cve]["bounty"]
        vulnerabilities.announced = parsedToSave[cve]["announced"]["date"]
        vulnerabilities.url = parsedToSave[cve]["announced"]["url"]
        vulnerabilities.code_reviews = parsedToSave[cve]["code_reviews"]
        vulnerabilities.bugs = parsedToSave[cve]["bugs"]
        vulnerabilities.fixes = parsedToSave[cve]["fixes"]
        vulnerabilities.files = cve
        vulnerabilities.save
    end

    #rails db:setup
end