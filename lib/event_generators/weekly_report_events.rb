require_relative '../../app/helpers/application_helper'
require 'json'
require 'date'
require 'writing'
require 'timing_logger'

class WeeklyReportEvents
  include ApplicationHelper

  def initialize
    @report_desc = markdown(Writing.event_article('weekly-overall'))
    @newdev_desc = markdown(Writing.event_article('weekly-newdevs'))
    @revert_desc = markdown(Writing.event_article('weekly-reverts'))
    @owner_desc = markdown(Writing.event_article('weekly-ownership'))
    @refactors_desc = markdown(Writing.event_article('weekly-refactors'))
  end

  def cve_from_filename(f)
    f.match(/.*(?<cve>CVE-.+-.+)-weekly.json/)[:cve]
  end

  def generate(repo_path)
    logger = TimingLogger.new(STDOUT, 'data:events:weeklies')
    events = []
    tags =   []
    vuln_events = []
    cooks_tag = add_cooks_tag
    logger.info "Parsing & prepping weeklies"
    Dir["#{repo_path}/commits/weeklies/*.json"].each do |file|
      json = File.open(file) { |f| JSON.load(f) }
      v = Vulnerability.find_by(cve: cve_from_filename(file))
      if v.nil?
        logger.warn "WARNING: weekly report for #{cve_from_filename(file)}, but vuln not found"
      else
        num_devs = 0
        new_events = []
        json.each do |_week, report|
          new_events << overall_report_event(v, report)
          new_events << new_developers_event(v, report)
          new_events << ownership_change(v, report)
          new_events << revert(v, report)
          new_events << refactor(v, report)
          num_devs += report['new_developers'].size
        end
        tags << too_many_cooks(v, cooks_tag, num_devs) if num_devs >= 10
        v.notes['num_devs'] = num_devs
        v.save
        vuln_events += new_events.compact.map do |e|
          VulnerabilityEvent.new(event: e, vulnerability: v)
        end
        events += new_events.compact
      end
    end
    logger.info "Inserting event and tag data"
    events.compact!
    Event.import events
    VulnerabilityEvent.import vuln_events
    VulnerabilityTag.import tags
  end

  # Always create an event for a week with commits
  def overall_report_event(v, report)
    churn = report['insertions'].to_i + report['deletions'].to_i
    num_devs = report['developers'].size.to_s
    drive_bys = report['drive_bys'] || []
    file_list = report['files'].map { |f| " * `#{f}`" }.join("\n")
    desc = @report_desc.gsub(':num_devs:', num_devs)
                       .gsub(':nice_date:', nice_date(report))
                       .gsub(':num_commits:', report['commits'].size.to_s)
                       .gsub(':num_insertions:', report['insertions'].to_s)
                       .gsub(':num_deletions:', report['deletions'].to_s)
                       .gsub(':num_files:', report['files'].size.to_s)
                       .gsub(':file_list:', markdown(file_list))
                       .gsub(':num_drive_bys:', drive_bys.size.to_s)
    commits = Hash.new
    report['commits'].each do | c |
      commit = Commit.find_by(commit_hash: c)
      commits[c] = commit.nil? ? "" : commit.date_created
    end

    files = Array.new
    report['files'].each do | file, index |
      path = Filepath.find_by(filepath: file)
      files.push({ file: file, slug: (path.nil? ? "" : path.slug) })
    end

    devs = Array.new
    report['developers'].each do | email |
      dev = Developer.find_by(email: email)
      devs.push(dev.nil? ? nil : dev.nickname)
    end

    Event.new(
      style: overall_report_style,
      date: report['date'],
      event_type: 'changes',
      title: "#{report['commits'].size} commits by #{num_devs} developers, " +
                      "#{churn} lines changed",
      description: desc,
      notes: "{\"commits\": #{commits.to_json}, \"developers\": #{devs.to_json}, \"files\": #{files.to_json}}",
      start_hidden: true
    )
  end

  def new_developers_event(v, report)
    return nil unless report['new_developers'].any?
    num_new_devs = report['new_developers'].size
    desc = @newdev_desc.gsub(':nice_date:', nice_date(report))
                       .gsub(':new_devs:', num_new_devs.to_s)

    devs = Array.new
    report['new_developers'].each do | email |
      dev = Developer.find_by(email: email)
      devs.push(dev.nil? ? nil : dev.nickname)
    end

    Event.new(
      style: new_dev_style,
      date: report['date'],
      event_type: 'new developer',
      title: "#{num_new_devs} new developer(s)",
      description: desc,
      notes: "{\"developers\": #{devs.to_json}}",
      start_hidden: true
    )
  end

  def ownership_change(v, report)
    return nil unless report['ownership_change']
    desc = @owner_desc.gsub(':nice_date:', nice_date(report))
    Event.new(
      style: ownership_style,
      date: report['date'],
      title: "Code ownership changed",
      event_type: 'owner change',
      description: desc,
      notes: "null",
      start_hidden: false
    )
  end

  def revert(v, report)
    return nil unless report['reverts'].size > 0
    desc = @revert_desc.gsub(':num_reverts:', report['reverts'].size.to_s)
                       .gsub(':nice_date:', nice_date(report))

    commits = Hash.new
    report['reverts'].each do | c |
      commit = Commit.find_by(commit_hash: c)
      commits[c] = commit.nil? ? "" : commit.date_created
    end

    Event.new(
      style: revert_style,
      date: report['date'],
      title: "#{report['reverts'].size.to_s} revert commit(s)",
      event_type: 'reverts',
      description: desc,
      notes: "{\"commits\": #{commits.to_json}}",
      start_hidden: false
    )
  end

  def refactor(v, report)
    return nil unless report['refactors'].size > 0
    desc = @refactors_desc.gsub(':num_refactors:', report['refactors'].size.to_s)
                          .gsub(':nice_date:', nice_date(report))

    commits = Hash.new
    report['refactors'].each do | c |
      commit = Commit.find_by(commit_hash: c)
      commits[c] = commit.nil? ? "" : commit.date_created
    end

    Event.new(
      style: refactor_style,
      date: report['date'],
      title: "#{report['refactors'].size.to_s} refactor commit(s)",
      event_type: 'refactors',
      description: desc,
      notes: "{\"commits\": #{commits.to_json}}",
      start_hidden: false
    )
  end

  def too_many_cooks(v, cooks_tag, num_devs)
    VulnerabilityTag.new(
      tag: cooks_tag,
      vulnerability: v,
      note: "#{num_devs} different developers have made commits to the files fixed for this vulnerability."
    )
  end

  def ownership_style
    @ownership_style ||= Style.find_or_create_by!(
      name: 'ownership style',
      icon: 'face',
      color: '#BB5093',
    )
  end

  def new_dev_style
    @new_dev_style ||= Style.find_or_create_by!(
      name: 'new_dev_style',
      icon: 'person',
      color: '#B7AADE',
    )
  end

  def overall_report_style
    @overall_report_style ||= Style.find_or_create_by!(
      name: 'overall_report_style',
      icon: 'assignment',
      color: '#bbbbbb',
    )
  end

  def revert_style
    @revert_style ||= Style.find_or_create_by!(
      name: 'revert_style',
      icon: 'compare_arrows',
      color: '#FF953D',
    )
  end

  def refactor_style
    @refactor_style ||= Style.find_or_create_by!(
      name: 'refactor_style',
      icon: 'healing',
      color: '#F4DC0C',
    )
  end

  def nice_date(report)
    DateTime.parse(report['date']).strftime('%A, %B %d, %Y')
  end

  def add_cooks_tag
    Tag.find_by(shortname: 'cooks') || Tag.create!(
      name: 'Lesson: Too Many Cooks',
      shortname: 'cooks',
      color: '#009696',
      icon: 'people',
      description: markdown(Writing.tag_article('cooks'))
    )
  end

end
