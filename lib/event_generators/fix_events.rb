require_relative '../../app/helpers/application_helper'

class FixEvents
  include ApplicationHelper

  def initialize(project)
    @project = project
    @desc = Writing.event_article('fix')
  end

  def generate
    events = []
    vuln_events = []
    Fix.joins(:vulnerability)
       .where('vulnerabilities.project_id' => @project.id)
       .each do |fix|
      e = Event.new(
        style: style,
        title: "Fix for #{fix.vulnerability.cve}: #{fix.commit.title}",
        event_type: 'fix',
        description: markdown(Writing.embed_details(@desc, fix))
      )
      events << e
      vuln_events << VulnerabilityEvent.new(
        vulnerability_id: fix.vulnerability_id,
        event: e
      )
    end
    Event.import events
    VulnerabilityEvent.import vuln_events
  end

  def style
    @style ||= Style.find_or_create_by!(
      name: 'fix',
      icon: 'lock',
      color: '#9FE69F',
    )
  end

  private

end
