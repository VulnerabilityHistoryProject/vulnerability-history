require_relative '../../app/helpers/application_helper'
require 'timing_logger'

class SameDirectoryEvents
  include ApplicationHelper

  def initialize(log = TimingLogger.new(STDOUT, 'data:events:same_dir'))
    @logger = log
  end

  def generate
    events = []
    query = <<~EOSQL
      INSERT INTO events(title, description, event_type, date, color, icon, start_hidden, vulnerability_id)
      SELECT DISTINCT 'Nearby vulnerability in ' || fp1.dir AS title,
                      'A vulnerability, ' || v2.cve || ', that was also fixed in this vulnerability''s directory ('|| fp1.filepath ||') was announced.' AS description,
                      'same directory' AS event_type,
                      v2.announced AS date,
                      'bug_report' AS icon,
                      '#5f606d' AS color,
                      TRUE AS start_hidden,
                      v1.id
            FROM vulnerabilities AS v1
              INNER JOIN vulnerabilities AS v2 ON (v1.id <> v2.id AND v1.project_id = v2.project_id)
              INNER JOIN fixes AS f1 ON (f1.vulnerability_id = v1.id)
              INNER JOIN fixes AS f2 ON (f2.vulnerability_id = v2.id)
              INNER JOIN commits AS c1 ON c1.id = f1.commit_id
              INNER JOIN commits AS c2 ON c2.id = f2.commit_id
              INNER JOIN commit_filepaths AS cf1 ON cf1.commit_id = c1.id
              INNER JOIN commit_filepaths AS cf2 ON cf2.commit_id = c2.id
              INNER JOIN filepaths AS fp1 ON cf1.filepath_id = fp1.id
              INNER JOIN filepaths AS fp2 ON cf2.filepath_id = fp2.id
              WHERE fp1.dir = fp2.dir
                    AND fp1.is_code = TRUE
                    AND fp2.is_code = TRUE
                    AND fp1.project_id = fp2.project_id
    EOSQL
    @logger.info "Execute mega INSERT/SELECT SQL query"
    begin
      ActiveRecord::Base.connection.execute(query)
    rescue
      @logger.warn 'Same directory query ran too long. Skipping.'
      return
    end

  end
end
