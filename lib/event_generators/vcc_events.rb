require_relative '../../app/helpers/application_helper'

class VccEvents
  include ApplicationHelper

  def initialize(project)
    @project = project
    @desc = Writing.event_article('vcc')
  end

  def vccs
    Vcc.joins(:vulnerability).where('vulnerabilities.project_id' => @project.id)
  end

  def generate
    logger = TimingLogger.new(STDOUT, 'data:events:vccs')
    events = []
    logger.info "Building model objects"
    vccs.each do |vcc|
      e = Event.new(
        title: "Vulnerability-contributing commit for #{vcc.vulnerability.cve}: #{vcc.commit.title}",
        date: vcc.commit.date,
        event_type: 'vcc',
        description: Writing.embed_details(@desc, vcc),
        icon: 'report_problem',
        color: '#ED6049',
        notes: {},
        start_hidden: false
      )
      events << e
    end
    logger.info "Importing events"
    Event.import events
  end
end
