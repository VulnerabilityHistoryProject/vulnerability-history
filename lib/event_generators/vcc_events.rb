class VccEvents

  def initialize
    tmpl = File.expand_path("markdown/vcc.md", __dir__)
    @desc = File.read(tmpl)
  end

  def generate
    events = []
    vuln_events = []
    Vcc.all.each do |vcc|
      e = Event.new(
        style: style,
        title: "Vulnerability-contributing commit for #{vcc.vulnerability.cve}: #{vcc.commit.title}",
        event_type: 'vcc',
        description: Writing.embed_details(@desc, vcc)
      )
      events << e
      vuln_events << VulnerabilityEvent.new(
        vulnerability_id: vcc.vulnerability_id,
        event: e
      )
    end
    Event.import events
    VulnerabilityEvent.import vuln_events
  end

  def style
    @style ||= Style.find_or_create_by!(
      name: 'vcc',
      icon: 'report_problem',
      color: '#ED6049',
    )
  end
end
