require_relative '../writing'
class SubsystemTagger

  def initialize(project)
    @project = project
    @cache = {}
  end

  def create_tags
    # Collect all tags from all project's vulnerabilities
    subs = Vulnerability.where(project: @project)
                        .select("DISTINCT notes->'subsystem'->'name' AS subs")
                        .map {|rs| rs.subs }
                        .flatten # handle arrays
                        .compact # remove nil
    subs.each do |sub|
      name = normalized sub
      t = Tag.find_or_create_by!(
        name: "#{@project.name} subsystem: #{name}",
        shortname: shortname(name),
        color: @project.fg_color,
        icon: 'cogs',
        description: <<~EOS
          #{Writing.tag_article(shortname(name), false)}

          #{Writing.tag_article('subsystem')}
        EOS
      )
      @cache[name] = t
    end
  end

  def apply_tags
    Vulnerability.where(project: @project).each do |v|
      Array(v.notes.dig('subsystem', 'name')).each do |sub|
        unless sub.empty?
          t = @cache[normalized(sub)]
          VulnerabilityTag.create!(vulnerability: v, tag: t)
        end
      end
    end
  end

  def normalized(name)
    name.to_s.downcase.strip
  end

  def shortname(name)
    "subsystem-#{@project.subdomain}-#{name.to_s.strip.parameterize}"
  end
end
