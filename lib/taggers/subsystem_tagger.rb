class SubsystemTagger

  def create_tags
    Vulnerability.all.each do |v|
      name = normalized v.notes.dig('subsystem', 'name')
      unless name.empty?
        @tag = Tag.find_by(shortname: name)
        if not @tag
          @tag = Tag.create!(
              name: "Subsystem: #{name}",
              shortname: shortname(name),
              color: '#cccccc',
              description: <<~EOS
            This tag is applied to all vulnerabilities that were discovered in the #{name} subsystem.
          EOS
          )
        end
      end
    end
  end

  def apply_tags
    Vulnerability.all.each do |v|
      name = normalized v.notes.dig('subsystem', 'name')
      unless name.empty?
        t = Tag.find_by(shortname: shortname(name))
        n = v.notes.dig('subsystem', 'answer').to_s
        VulnerabilityTag.create!(vulnerability: v, tag: t, note: n)
      end
    end
  end

  def normalized(name)
    name.to_s.downcase.strip
  end

  def shortname(name)
    "subsystem-#{normalized(name)}"
  end
end
