require_relative '../writing'

class ForgottenCheckTagger

  def initialize(project)
    @project = project
  end

  def create_tags
    @forgotten_tag = Tag.find_or_create_by!(
      name: 'Forgotten Check',
      shortname: 'forgot-check',
      color: '#DC143C',
      icon: 'forgotten',
      description: Writing.tag_article('forgot-check')
    )
  end

  def apply_tags
    Vulnerability.where(project: @project).each do |v|
      if forgotten?(v)
        ForgottenCheckTagger.create!(
          vulnerability: v,
          tag: @forgotten_tag,
          importance: 0.25,
        )
      end
    end
  end

  def forgotten?(v)
    forgotten = false
    if v.notes.dig('forgotten_check').present? #forgotten_check present
      if v.notes.dig('forgotten_check')['answer']  #answer present
        forgotten = v.notes.dig('forgotten_check')['answer']
      end
    end
    if !!forgotten != forgotten  # not a boolean value, CVE contained a string for answer
      forgotten = false
    end
    forgotten
  end
end
