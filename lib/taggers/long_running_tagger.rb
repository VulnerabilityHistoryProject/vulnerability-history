require_relative '../writing'
class LongRunningTagger

  def initialize(project)
    @project = project
  end

  def create_tags
    @Long_Running_Tag = Tag.find_or_create_by!(
      name: 'Long Running Vulnerability',
      shortname: 'long-running',
      icon: 'hourglass',
      color: '#e0454d',
      description: Writing.tag_article('long-running')
    )
  end

  def apply_tags
    tags = []
    query = "SELECT DISTINCT v.id FROM vulnerabilities AS v
              INNER JOIN fixes AS fix ON fix.vulnerability_id = v.id
              INNER JOIN vccs AS vcc ON vcc.vulnerability_id = v.id
              INNER JOIN commits AS commit1 ON commit1.id = vcc.commit_id
              INNER JOIN commits AS commit2 ON commit2.id = fix.commit_id
              WHERE (commit2.date_created - commit1.date_created) > '2 years'
              AND v.project_id = '#{@project.id}'
            "

    results = ActiveRecord::Base.connection.execute(query)
    results.each do |v|
      t = VulnerabilityTag.new(
        vulnerability_id: v['id'],
        importance: 0.4, # Pretty important. TODO scale this out according to multiple tags, one for each year. e.g. Lifetime: 1 year, etc. Then change importance based on that.
        tag: @Long_Running_Tag
      )
      tags << t
    end
    VulnerabilityTag.import tags
  end
end
