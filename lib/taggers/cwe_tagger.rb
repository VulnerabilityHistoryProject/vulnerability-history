require 'csv'

class CWETagger

  def create_tags
    @tagged_cwes.each do |cwe_id, entry|
        Tag.find_or_create_by!(entry)
    end
  end

  def apply_tags
    vuln_tags = []
    untagged = []
    Vulnerability.all.each do |v|
      if @tagged_cwes.key? normalized_cwe_string(v.notes['CWE'])
        vuln_tags << VulnerabilityTag.new(
          vulnerability: v,
          tag: find_tag(v.notes['CWE']),
          note: ''
        )
      else
        puts "WARNING: Un-tagged CWE: #{v.notes['CWE']} in #{v.cve}" unless v.notes['CWE'].to_s.blank?
        untagged << normalized_cwe_string(v.notes['CWE'])
      end
    end
    VulnerabilityTag.import vuln_tags
    # puts "Untagged, normalized: #{untagged.sort}"
  end

  # If people entered in text here, just take the number
  # e.g. CWE-122 ==> 122
  def normalized_cwe_string(cwe)
    cwe.to_s.gsub(/[^0-9]/,'').to_i
  end

  def find_tag(cwe_str)
    shortname = @tagged_cwes[normalized_cwe_string(cwe_str)][:shortname]
    Tag.find_by(shortname: shortname)
  end

  def initialize
    @tagged_cwes = {}
    CSV.foreach(Rails.root + "lib/taggers/resources/cwes.csv") do |fields|
      @tagged_cwes[fields[0].to_i] = {
        name: "CWE-#{fields[0]}: #{fields[1]}",
        shortname: "cwe-#{fields[0]}",
        color: '#99ccff',
        description: fields[4]
      }
    end
  end

end
