require 'set'
require_relative '../writing'
class LanguageTagger

  def initialize(project)
    @project = project
  end

  def create_tags
    @c_tag = Tag.find_or_create_by!(
        name: 'Language: C',
        shortname: 'C',
        color: '#890808',
        description: Writing.tag_article('C')
    )

    @cpp_tag = Tag.find_or_create_by!(
        name: 'Language: C++',
        shortname: 'C++',
        color: '#890808',
        description: Writing.tag_article('C++')
    )

    @js_tag = Tag.find_or_create_by!(
        name: 'Language: Javascript',
        shortname: 'JS',
        color: '#890808',
        description: Writing.tag_article('JS')
    )

    @java_tag = Tag.find_or_create_by!(
        name: 'Language: Java',
        shortname: 'Java',
        color: '#890808',
        description: Writing.tag_article('Java')
    )

    @py_tag = Tag.find_or_create_by!(
        name: 'Language: Python',
        shortname: 'Python',
        color: '#890808',
        description: Writing.tag_article('Python')
    )
  end

  def apply_tags
    Vulnerability.where(project: @project).each do |v|
      findTags(v)
      @tags.each do |t|
        if t
          VulnerabilityTag.create!(
            vulnerability: v,
            tag: t
          )
        end
      end
    end
  end

  def findTags(v)
    @tags = Set[]
    Filepath.vulnerable(v).each do |vf|
      fields = vf.filepath.split('.')
      extension = fields[-1]
      if (extension == 'c')
        @tags << @c_tag
      elsif (extension == 'cc' or extension == 'cpp')
        @tags << @cpp_tag
      elsif (extension == 'java')
        @tags << @java_tag
      elsif (extension == 'js')
        @tags << @js_tag
      elsif (extension == 'py')
        @tags << @py_tag
      end
    end
  end
end
