class FixTagger

  def create_tags
    @big_fix_tag = Tag.create!(
      name: 'Fix: Big',
      shortname: 'big fix',
      color: '#9FE69F',
      description: "This tag is applied when at least one fix for the vulnerability has more than 100 lines of changed code."
    )
    @small_fix_tag = Tag.create!(
      name: 'Fix: Small',
      shortname: 'small fix',
      color: '#9FE69F',
      description: "This tag is applied when at least one fix for the vulnerability has fewer than 20 lines of changed code."
    )
  end

  def apply_tags
    tags = []
    query = "SELECT DISTINCT vulnerabilities.id FROM commit_filepaths
              INNER JOIN fixes ON commit_filepaths.commit_id = fixes.commit_id
              INNER JOIN vulnerabilities ON fixes.vulnerability_id = vulnerabilities.id
              GROUP BY vulnerabilities.id,fixes.commit_id
              HAVING SUM(total_churn) > 100;"
    results = ActiveRecord::Base.connection.execute(query)

    results.each do |v|
      t = VulnerabilityTag.new(
        vulnerability_id: v['id'],
        tag: @big_fix_tag
      )
      tags << t
    end

    query = "SELECT DISTINCT vulnerabilities.id FROM commit_filepaths
              INNER JOIN fixes ON commit_filepaths.commit_id = fixes.commit_id
              INNER JOIN vulnerabilities ON fixes.vulnerability_id = vulnerabilities.id
              GROUP BY vulnerabilities.id,fixes.commit_id
              HAVING SUM(total_churn) < 20;"
    results = ActiveRecord::Base.connection.execute(query)

    results.each do |v|
      t = VulnerabilityTag.new(
        vulnerability_id: v['id'],
        tag: @small_fix_tag
      )
      tags << t
    end

    VulnerabilityTag.import tags
  end
end
