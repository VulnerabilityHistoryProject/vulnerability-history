require_relative '../writing'

class StackTraceTagger

  def initialize(project)
    @project = project
  end

  def create_tags
    @any_stack_trace = Tag.find_or_create_by!(
      name: 'Any Stack Trace',
      shortname: 'stack-any',
      color: '#fdad5c',
      icon: 'stack-any',
      description: Writing.tag_article('stack-any')
    )
    @stack_with_fix = Tag.find_or_create_by!(
      name: 'Stack Trace with Fix',
      shortname: 'stack-fix',
      color: '#B6EE56',
      icon: 'stack-fix',
      description: Writing.tag_article('stack-fix')
    )
  end

  def apply_tags
    Vulnerability.where(project: @project).each do |v|
      find_stack(v)
      @tags.each do |tag|
        if tag
          VulnerabilityTag.create!(
            vulnerability: v,
            tag: tag
          )
        end
      end
    end
  end

  def find_stack(v)
    @tags = Set[]
    if v.notes.dig('stacktrace').present? #stacktrace present
      if v.notes.dig('stacktrace', 'any_stacktraces').present? #any_stacktraces present
        if v.notes.dig('forgotten_check', 'any_stacktraces') == true
          @tags << @any_stack_trace
        end
      end
      if v.notes.dig('stacktrace', 'stacktrace_with_fix').present? #stacktrace_with_fix present
        if v.notes.dig('forgotten_check', 'stacktrace_with_fix') == true
          @tags << @stack_with_fix
        end
      end
    end
  end

end