require 'yaml'
require_relative '../writing'

class OriginTagger

  def create_tags
    @Origin_tag = Tag.create!(
      name: 'Origin Vulnerability',
      shortname: 'Origin',
      color: '#d845e0',
      description: Writing.tag_article('Origin')
    )
  end

  def make_where(commits)
    where = "commit_hash in ("
    commits.each do |commit|
      where += "'#{commit}',"
    end
    where = where[0...-1]
    return where + ')'
  end

  def apply_tags(repo_path)
    tags = []
    commits = []
    y = File.open("#{repo_path}/commits/origin_commits.yml") { |f| YAML.load(f) }
    y.each do |commit|
      commits << commit["commit"]
    end
    vulns = Vulnerability.joins(vccs: :commit).where(make_where(commits))
    vulns.each do |v|
      t = VulnerabilityTag.new(
        vulnerability: v,
        tag: @Origin_tag
      )
      tags << t
    end
    VulnerabilityTag.import tags
  end
end
