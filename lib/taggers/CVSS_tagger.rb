require_relative '../writing'

class CVSSTagger

  def initialize
    @codes_to_names = {
      'AV:N' => ['Attack Vector - Network', 'attack_vector'],
      'AV:A' => ['Attack Vector - Adjacent Network', 'attack_vector'],
      'AV:L' => ['Attack Vector - Local', 'attack_vector'],
      'AV:P' => ['Attack Vector - Physical', 'attack_vector'],
      'AC:L' => ['Attack Complexity - Low', 'attack_complexity'],
      'AC:M' => ['Attack Complexity - Medium', 'attack_complexity'],
      'AC:H' => ['Attack Complexity - High', 'attack_complexity'],
      'Au:M' => ['Privileges Required - High', 'privileges_required'],
      'PR:H' => ['Privileges Required - High', 'privileges_required'],
      'Au:S' => ['Privileges Required - Low', 'privileges_required'],
      'PR:L' => ['Privileges Required - Low', 'privileges_required'],
      'Au:N' => ['Privileges Required - None', 'privileges_required'],
      'PR:N' => ['Privileges Required - None', 'privileges_required'],
      'UI:R' => ['User Interaction - Required', 'user_interaction'],
      'UI:N' => ['User Interaction - None', 'user_interaction'],
      'S:C' => ['Scope - Changed', 'scope'],
      'S:U' => ['Scope - Unchanged', 'scope'],
      'C:C' => ['Confidentiality Impact - Complete', 'confidentiality_impact'],
      'C:H' => ['Confidentiality Impact - High', 'confidentiality_impact'],
      'C:P' => ['Confidentiality Impact - Partial', 'confidentiality_impact'],
      'C:L' => ['Confidentiality Impact - Low', 'confidentiality_impact'],
      'I:C' => ['Integrity Impact - Complete', 'integrity_impact'],
      'I:H' => ['Integrity Impact - High', 'integrity_impact'],
      'I:P' => ['Integrity Impact - Partial', 'integrity_impact'],
      'I:L' => ['Integrity Impact - Low', 'integrity_impact'],
      'A:C' => ['Availability Impact - Complete', 'availability_impact'],
      'A:H' => ['Availability Impact - High', 'availability_impact'],
      'A:P' => ['Availability Impact - Partial', 'availability_impact'],
      'A:L' => ['Availability Impact - Low', 'availability_impact'],
    }

    @all_tags = Hash.new
    @codes_to_names.each do |code, fullname_list|
      fullname = fullname_list[0]
      fields = fullname.split(' - ')
      family_title = fullname_list[1]
      @all_tags[code] = {
        name: "Severity: #{fullname}",
        shortname: shortname(code),
        color: '#99ccff',
        description: Writing.tag_article(shortname(code)),
        family: family_title,
        tag_grouping: TagGrouping.find_by(slug: 'severity')
      }
    end
  end

  def shortname(code)
    "cvss-#{code.parameterize}"
  end

  def create_tags
    @cvss_tags = Hash.new
    Vulnerability.all.each do |v|
      if v.notes.dig("CVSS") != nil
        cvss = v.notes.dig('CVSS')
        fields = cvss.split('/')
        for field in fields
          if @all_tags.has_key?(field)
            t = Tag.find_or_create_by!(@all_tags[field])
            @cvss_tags[field] = t
          end
        end
      end
    end
  end

  def apply_tags
    vuln_tags = []
    Vulnerability.all.each do |v|
      if v.notes.dig("CVSS") != nil
        fields = v.notes.dig("CVSS").split('/')
        for field in fields
          t = @cvss_tags[field]
          vuln_tags << VulnerabilityTag.new(
            vulnerability: v,
            tag: t,
            importance: importance(field),
            note: ''
          )
        end
      end
    end
    VulnerabilityTag.import vuln_tags
  end

  # These are based on my totally unscientific understanding of severity
  # comparisons.
  # I'd LOVE to see some rigorous science on these importance measures.
  # But even FIRST can't be bothered to be transparent about they came up with
  # their (frankly weird) weights. There's no science on this yet.
  # So I'm gonna pull this out of my ass because apparently that's allowed.
  def importance(field)
    case field
    when 'AV:N' then 0.5
    when 'AV:A' then 0.2
    when 'AV:L' then 0.1
    when 'AV:P' then 0.1
    when 'AC:L' then 0.5
    when 'AC:M' then 0.2
    when 'AC:H' then 0.1
    when 'Au:M' then 0.2
    when 'PR:H' then 0.2
    when 'Au:S' then 0.2
    when 'PR:L' then 0.2
    when 'Au:N' then 0.6
    when 'PR:N' then 0.6
    when 'UI:R' then 0.1
    when 'UI:N' then 0.8
    when 'S:C' then 0.5
    when 'S:U' then 0.3
    when 'C:C' then 0.7
    when 'C:H' then 0.7
    when 'C:P' then 0.3
    when 'C:L' then 0.1
    when 'I:C' then 0.7
    when 'I:H' then 0.7
    when 'I:P' then 0.5
    when 'I:L' then 0.1
    when 'A:C' then 0.7
    when 'A:H' then 0.7
    when 'A:P' then 0.5
    when 'A:L' then 0.1
    else 0.0
    end
  end

end
