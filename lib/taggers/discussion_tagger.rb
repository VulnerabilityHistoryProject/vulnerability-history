require_relative '../writing'

class DiscussionTagger

  def initialize
  end

  def create_tags
    @security_discussion = Tag.find_or_create_by!(
      name: 'Discussion: Security',
      shortname: 'discussion-security',
      color: '#00008b',
      icon: 'discussion-sec',
      description: Writing.tag_article('discussion-security'),
      family: 'discussed_security',
      tag_grouping: TagGrouping.find_by(slug: 'process'),
    )
    @any_discussion = Tag.find_or_create_by!(
      name: 'Discussion: Any',
      shortname: 'discussion-any',
      color: '#00468b',
      icon: 'discussion-any',
      description: Writing.tag_article('discussion-any'),
      family: 'discussed_any',
      tag_grouping: TagGrouping.find_by(slug: 'process'),
    )
  end

  def apply_tags
    Vulnerability.all.each do |v|
      find_discussion(v)
      @tags.each do |tag|
        if tag
          VulnerabilityTag.create!(
            vulnerability: v,
            tag: tag
          )
        end
      end
    end
  end

  def find_discussion(v)
    @tags = Set[]
    if v.notes.dig('discussion', 'discussed_as_security').present? #discussed_as_security present
      if v.notes.dig('discussion', 'discussed_as_security') == true
        @tags << @security_discussion
      end
    end
    if v.notes.dig('discussion', 'any_discussion').present? #any_discussion present
      if v.notes.dig('discussion', 'any_discussion') == true
        @tags << @any_discussion
      end
    end
  end

end