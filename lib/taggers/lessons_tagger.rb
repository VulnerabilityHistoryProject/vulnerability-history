class LessonsTagger

  def create_tags
    @lessons = [ 'defense_in_depth', 'least_privilege', 'frameworks_are_optional', 'native_wrappers', 'distrust_input', 'security_by_obscurity', 'serial_killer', 'environment_variables', 'secure_by_default', 'yagni', 'complex_inputs']
    @tags = Hash.new

    @tags['defense_in_depth'] = Tag.create!(
        name: 'Defense in Depth',
        shortname: 'defense',
        color: '#009696',
        description: <<~EOS
        This tag is applied when a lesson can be learned about defense in depth.
    EOS
    )
    @tags['least_privilege'] = Tag.create!(
        name: 'Least Privilege',
        shortname: 'least privilege',
        color: '#009696',
        description: <<~EOS
        This tag is applied when a lesson can be learned about the principle of least privilege.
    EOS
    )
    @tags['frameworks_are_optional'] = Tag.create!(
        name: 'Frameworks are Optional',
        shortname: 'optional frameworks',
        color: '#009696',
        description: <<~EOS
        This tag is applied when a lesson can be learned about frameworks being optional.
    EOS
    )
    @tags['native_wrappers'] = Tag.create!(
        name: 'Native Wrappers',
        shortname: 'wrappers',
        color: '#009696',
        description: <<~EOS
        This tag is applied when a lesson can be learned about native wrappers.
    EOS
    )
    @tags['distrust_input'] = Tag.create!(
        name: 'Distrust Input',
        shortname: 'distrust input',
        color: '#009696',
        description: <<~EOS
        This tag is applied when a lesson can be learned about distrusting input.
    EOS
    )
    @tags['security_by_obscurity'] = Tag.create!(
        name: 'Security By Obscurity',
        shortname: 'obscurity',
        color: '#009696',
        description: <<~EOS
        This tag is applied when a lesson can be learned about security by obscurity.
    EOS
    )
    @tags['serial_killer'] = Tag.create!(
        name: 'Serial Killer',
        shortname: 'serial',
        color: '#009696',
        description: <<~EOS
        This tag is applied when a lesson can be learned about serialization.
    EOS
    )
    @tags['environment_variables'] = Tag.create!(
        name: 'Environment Variables',
        shortname: 'environment',
        color: '#009696',
        description: <<~EOS
        This tag is applied when a lesson can be learned about environment variables.
    EOS
    )
    @tags['secure_by_default'] = Tag.create!(
        name: 'Secure By Default',
        shortname: 'secure by default',
        color: '#009696',
        description: <<~EOS
        This tag is applied when a lesson can be learned about being secure by default.
    EOS
    )
    @tags['yagni'] = Tag.create!(
        name: 'You Ain\'t Gonna Need It',
        shortname: 'yagni',
        color: '#009696',
        description: <<~EOS
        This tag is applied when a lesson can be learned about the principle of "You Ain't Gonna Need It".
    EOS
    )
    @tags['complex_inputs'] = Tag.create!(
        name: 'Complex Inputs',
        shortname: 'complex inputs',
        color: '#009696',
        description: <<~EOS
        This tag is applied when a lesson can be learned about complex inputs.
    EOS
    )

  end

  def apply_tags
    Vulnerability.all.each do |v|
      findTags(v)
      @found_tags.each do |t|
        VulnerabilityTag.create!(
                            vulnerability: v,
                            tag: @tags[t],
                            note: <<~EOS
                              #{v.notes.dig('lessons', t, 'note').to_s.sub!("\n", ' ')}
                            EOS
        )
      end
    end
  end

  def findTags(v)
    @found_tags = []
    @lessons.each do |l|
      if v.notes.dig('lessons', l, 'applies')
        @found_tags << l
      end
    end
  end

end
