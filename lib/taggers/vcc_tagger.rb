require_relative '../writing'

class VCCTagger

  def initialize(project)
    @project = project
  end

  def create_tags
    @vcc_tag = Tag.find_or_create_by!(
        name: 'VCC',
        shortname: 'vcc',
        color: '#c686d9',
        icon: 'vcc',
        description: Writing.tag_article('vcc')
    )
  end

  def apply_tags
    Vulnerability.where(project: @project).each do |v|
      if has_vcc?(v)  # vcc present
        VulnerabilityTag.create!(
            vulnerability: v,
            tag: @vcc_tag,
            importance: 0.25,
            )
      end
    end
  end

  def has_vcc?(v)
    hasVcc = false
    if v.notes.dig('vccs').present?
      v.notes.dig('vccs').each do |val| #loop through the vcc list
        hasVcc = val['commit'].to_s.length > 0 || val['note'].to_s.length > 0
        if hasVcc
          break
        end
      end
    end
    hasVcc
  end
end