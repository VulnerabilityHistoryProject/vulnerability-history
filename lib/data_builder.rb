require 'git'
require 'yaml'
require 'fileutils'
require 'find'
require 'timing_logger'
require_relative 'project_constants'
require_all 'lib/event_generators/*.rb'
require_all 'lib/loaders/*.rb'
require_all 'lib/taggers/*.rb'

# Clones, builds, and aggregates data for the projects.
class DataBuilder
  # Project has a name and designated logger
  def initialize
    @logger = TimingLogger.new(STDOUT, "data:build")
    # @git_branch = ENV['VHP_DATA_BRANCH'] || 'master'
    @git_branch = ENV['VHP_DATA_BRANCH'] || 'monorepo'

    # @git_address = "https://github.com/VulnerabilityHistoryProject/#{@repo_name}.git"
    @vuln_git_address = "../vulnerabilities"
    @vuln_git_dir = "./tmp/checkout/vulnerabilities"

    @mining_git_address = "../vhp-mining"
    @mining_git_dir = "./tmp/checkout/vhp-mining"

  end

  # Checks to see if the data is currently built.
  def check_exist
    @logger.warn "Data already loaded. Run data:clear first." if Project.any?
  end

  # Clones project data from the set Git repository.
  def clone_vuln_repo
    @logger.info "Removing vulnerabilities git folder..."
    FileUtils.rm_rf @vuln_git_dir if File.exist?(@vuln_git_dir)

    @logger.info "Cloning vuln repo from GitHub on #{@git_branch}..."
    g = Git.clone(@vuln_git_address, 'vulnerabilities',
      path: './tmp/checkout',
      branch: @git_branch,
      depth: 1)

    @logger.info "Loaded vulnerability data version: #{g.object('HEAD').sha[0..10]}"
  end

  def clone_mining_repo
    @logger.info "Removing vhp-mining git folders..."
    FileUtils.rm_rf @mining_git_dir if File.exist?(@mining_git_dir)

    @logger.info "Cloning mining repo from GitHub on #{@git_branch}..."
    g = Git.clone(@mining_git_address, 'vhp-mining',
      path: './tmp/checkout',
      branch: @git_branch,
      depth: 1)

    @logger.info "Loaded mining data version: #{g.object('HEAD').sha[0..10]}"
  end

  # Load base data into db.
  def load_data
    [
      ProjectLoader.new(@vuln_git_dir),
      GitLoader.new(@mining_git_dir, @vuln_git_dir),
      # CodeNoteLoader.new(@vuln_git_dir),
      # ReleaseLoader.new(@vuln_git_dir),
      VulnerabilityLoader.new(@vuln_git_dir),
    ].each do |loader|
      @logger.info "Running #{loader.class}..."
      loader.load_data
    end
  end

  # Load only vulnerability YMLs in - for merging-and-testing PRs efficiently.
  def load_vulns_only
    [
      ProjectLoader.new(@vuln_git_dir),
      VulnerabilityLoader.new(@vuln_git_dir),
    ].each do |loader|
      @logger.info "Running #{loader.class}..."
      loader.load_data
    end
  end

  # Generate event models.
  def generate_events
    [
      VulnerabilityEvents,
      SameCweEvents,
      SameDirectoryEvents,
      FixEvents,
      VccEvents,
      BountyEvents
    ].each do |generator|
      @logger.info "Generating #{generator.to_s.tableize.humanize.downcase}"
      generator.new.generate
    end
    @logger.info "Generating weekly report events and tags"
    WeeklyReportEvents.new.generate(@vuln_git_dir, @mining_git_dir)
  end

  # Generate and apply tags.
  def generate_tags
    [
      LifetimeTagger,
      BountyTagger,
      DEPSTagger,
      ErrorOfOmissionTagger,
      CWETagger,
      CVSSTagger,
      DiscoveryTagger,
      ErrorOfOmissionTagger,
      LanguageTagger,
      LessonsTagger,
      FixTagger,
      SubsystemTagger,
      UnitTestTagger,
      VCCTagger,
      ForgottenCheckTagger,
      OrderOfOperationsTagger,
      StackTraceTagger,
      VouchTagger,
      DiscussionTagger,
      SandBoxTagger,
      SpecificationTagger,
      AutoDiscoverableTagger,
      I18nTagger,
      UtilTagger,
      ProjectTagger
    ].each do |tagger|
      @logger.info "Tagging with #{tagger}"
      t = tagger.new
      t.create_tags
      t.apply_tags
    end
    @logger.info "Tagging with OriginTagger"
    orig = OriginTagger.new
    orig.create_tags
    orig.apply_tags(@vuln_git_dir, @mining_git_dir)
  end
end
