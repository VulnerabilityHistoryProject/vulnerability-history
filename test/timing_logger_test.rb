require 'test_helper'
require 'timing_logger'

class TimingLoggerTest < ActiveSupport::TestCase

  test 'log once' do
    out = StringIO.new
    travel_to DateTime.new 1984, 05, 19, 07, 35, 03
    log = TimingLogger.new(out, 'prog')
    travel_to DateTime.new 1984, 05, 19, 07, 35, 13 # 10s later
    log.info "log once"

    expected = <<~EOS
[INFO 1984-05-19 03:35:13 prog] log once                                
    EOS

    assert_equal expected, out.string
  end

  test 'log with warnings in between' do
    out = StringIO.new

    travel_to DateTime.new 1984, 05, 19, 07, 35, 03
    log = TimingLogger.new(out, 'prog')

    travel_to DateTime.new 1984, 05, 19, 07, 35, 13 # 10s later
    log.info "info first"

    travel_to DateTime.new 1984, 05, 19, 07, 35, 15 # 10s later
    log.warn "WARNING"

    travel_to DateTime.new 1984, 05, 19, 07, 37, 13 # 120s since last info
    log.info "info second blah blah"

    expected = <<~EOS
[INFO 1984-05-19 03:35:13 prog] info first                               (10.0s)
[WARN 1984-05-19 03:35:15 prog] WARNING
[INFO 1984-05-19 03:37:13 prog] info second blah blah                   (120.0s)
    EOS


    assert_equal expected, out.string
  end

end
