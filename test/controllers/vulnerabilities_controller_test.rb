require 'test_helper'
require 'loaders/vulnerability_loader'

class VulnerabilitiesControllerTest < ActionDispatch::IntegrationTest

  test 'generate from routes' do
    assert_routing '/vulnerabilities',
      controller: 'vulnerabilities',
      action: 'index'
  end

  test 'basic vuln route works' do
    assert_routing "/vulnerabilities/CVE-2011-3092",
      controller: "vulnerabilities",
      action: "show",
      id: 'CVE-2011-3092'
  end

  test 'bad vuln route raises error' do
    assert_raise(ActionController::RoutingError) do
      get "/vulnerabilities/abc"
    end
  end

  test 'just CVE in the URL' do
    expected = {
      controller: 'vulnerabilities',
      action: 'show',
      id: 'CVE-2011-3092'
    }
    assert_recognizes expected, "/CVE-2011-3092"
  end

  test 'Checks routing for similarVulnerabilities' do
    assert_routing '/api/vulnerabilities/CVE-2013-2878/same-cwe', controller: "vulnerabilities", action: "similarVulnerabilities", id: "CVE-2013-2878", similarity: "same-cwe"
    assert_recognizes({controller: 'vulnerabilities', action: 'similarVulnerabilities', id: 'CVE-2013-2878', similarity: 'same-cwe'}, '/api/vulnerabilities/CVE-2013-2878/same-cwe')
  end


  test 'Checks invalid input to similarVulnerabilities' do
    get "/api/vulnerabilities/CVE-2013-2878/invalid"
    assert_response :bad_request
    assert_match /Error: Invalid/, @response.body
  end

  test 'Checks valid input to similarVulnerabilities' do
    get "/api/vulnerabilities/CVE-2013-2878/same-cwe"
    assert_response :success
    expected = Vulnerability.similarVulnerabilities('CVE-2013-2878', 'cwe', 10, 0).to_json
    assert_equal expected, @response.body
  end

  test 'Checks valid input to similarVulnerabilities with lessons and checks offset and limit' do
    get "/api/vulnerabilities/CVE-2013-2878/same-lessons?offset=1&limit=20"
    assert_response :success
    expected = Vulnerability.similarVulnerabilities('CVE-2013-2878', 'lessons', 20, 1).to_json
    assert_equal expected, @response.body
  end

  
end
