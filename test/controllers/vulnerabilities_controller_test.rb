require 'test_helper'
require 'loaders/vulnerability_loader'

class VulnerabilitiesControllerTest < ActionDispatch::IntegrationTest

  test 'generate from routes' do
    assert_routing '/vulnerabilities',
      controller: 'vulnerabilities',
      action: 'index'
  end

  test 'basic vuln route works' do
    assert_routing "/vulnerabilities/CVE-2011-3092",
      controller: "vulnerabilities",
      action: "show",
      id: 'CVE-2011-3092'
  end

  test 'bad vuln route raises error' do
    assert_raise(ActionController::RoutingError) do
      get "/vulnerabilities/abc"
    end
  end

  test 'just CVE in the URL' do
    expected = {
      controller: 'vulnerabilities',
      action: 'show',
      id: 'CVE-2011-3092'
    }
    assert_recognizes expected, "/CVE-2011-3092"
  end

  test 'Checks routing for same-cwe' do
    assert_routing '/api/vulnerabilities/CVE-2013-2878/same-cwe', controller: "vulnerabilities", action: "sameCWE", id: "CVE-2013-2878"
    assert_recognizes({controller: 'vulnerabilities', action: 'sameCWE', id: 'CVE-2013-2878'}, '/api/vulnerabilities/CVE-2013-2878/same-cwe')
  end

  test 'Checks routing for same-directory' do
    assert_routing '/api/vulnerabilities/CVE-2013-2878/same-directory', controller: "vulnerabilities", action: "sameDirectory", id: "CVE-2013-2878"
    assert_recognizes({controller: 'vulnerabilities', action: 'sameDirectory', id: 'CVE-2013-2878'}, '/api/vulnerabilities/CVE-2013-2878/same-directory')
  end

  test 'Checks routing for same-lessons' do
    assert_routing '/api/vulnerabilities/CVE-2013-2878/same-lessons', controller: "vulnerabilities", action: "sameLessons", id: "CVE-2013-2878"
    assert_recognizes({controller: 'vulnerabilities', action: 'sameLessons', id: 'CVE-2013-2878'}, '/api/vulnerabilities/CVE-2013-2878/same-lessons')
  end

  test 'Checks invalid input to same-cwe' do
    get "/api/vulnerabilities/CVE-3223-2324/same-cwe"
    assert_response :bad_request
    assert_match /Error: /, @response.body
  end

  test 'Checks invalid input to same-lessons' do
    get "/api/vulnerabilities/CVE-2424-5555/same-lessons"
    assert_response :bad_request
    assert_match /Error: /, @response.body
  end
  
  test 'Checks invalid input to same-directory' do
    get "/api/vulnerabilities/CVE-3223-2324/same-directory"
    assert_response :bad_request
    assert_match /Error: /, @response.body
  end


  test 'Checks valid input to same-cwe' do
    get "/api/vulnerabilities/CVE-2013-2878/same-cwe"
    assert_response :success
    expected = Vulnerability.sameCWE('CVE-2013-2878', 10, 0).to_json
    assert_equal expected, @response.body
  end

  test 'Checks valid input to same-directory' do
    get "/api/vulnerabilities/CVE-2011-3093/same-directory"
    assert_response :success
    expected = Vulnerability.sameDirectory('CVE-2011-3093', 10, 0).to_json
    assert_equal expected, @response.body
  end

  test 'Checks valid input to same-lessons with lessons and checks offset and limit' do
    get "/api/vulnerabilities/CVE-2013-2878/same-lessons"
    assert_response :success
    expected = Vulnerability.sameLessons('CVE-2013-2878', 10, 0).to_json
    assert_equal expected, @response.body
  end

  
end
