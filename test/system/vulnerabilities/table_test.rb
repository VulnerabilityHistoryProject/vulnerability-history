require "application_system_test_case"

class TableTest < ApplicationSystemTestCase
  setup do
    Capybara.app_host = "https://alpha.vulnerabilityhistory.org"
    Capybara.run_server = false

    @start = vulnerabilities_path
  end

  test 'vulnerabilities table nav pagination' do
    visit @start
    gc = find('.grid-container')
    vulnerability_tabs = gc.all('.tabs-panel')[0]
    assert_equal 'is-active', vulnerability_tabs[:class][/is-active/]
   
    datatable_wrapper = vulnerability_tabs.find('#datatable_wrapper')
    table = datatable_wrapper.find('table')
    table_body = table.find('tbody')
    nav = datatable_wrapper.find("#table-nav-top")
    pagination = nav.find('.dataTables_length').find('label')
    assert_equal "Show", pagination.text[0..3]

    # show 10 vulnerabilities on page
    pagination.select('10')
    assert_equal 10, table_body.all('tr').length

    # show 25 vulnerabilities on page
    pagination.select('25')
    assert_equal 25, table_body.all('tr').length

    # show 50 vulnerabilities on page
    pagination.select('50')
    assert_equal 50, table_body.all('tr').length

    # show 100 vulnerabilities on page
    pagination.select('100')
    assert_equal 100, table_body.all('tr').length
  end

  test 'vulnerabilities table nav filter' do
    visit @start 
    gc = find('.grid-container')
    vulnerability_tabs = gc.all('.tabs-panel')[0]
    assert_equal 'is-active', vulnerability_tabs[:class][/is-active/]
    datatable_wrapper = vulnerability_tabs.find('#datatable_wrapper')
    page_row = datatable_wrapper.find('.row').find('.pagination')
    table = datatable_wrapper.find('table')
    table_body = table.find('tbody')
    nav = datatable_wrapper.find("#table-nav-top")

    # just test a few filters since there are so many - one that brings a lot, a little, and none
    filter = nav.find('.table-nav-filter')
    filter.select('Lesson: Error of Omission')
    assert_equal 10, table_body.all('tr').length
    assert_equal '3', page_row.all('li')[-2].text

    filter = nav.find('.table-nav-filter')
    filter.select('CWE-653: Insufficient Compartmentalization')
    assert_equal 2, table_body.all('tr').length
    
    filter = nav.find('.table-nav-filter')
    filter.select("CWE-79: Improper Neutralization of Input During Web Page Generation ('Cross-site Scripting')")
    assert_equal 1, table_body.all('tr').length
    assert_equal 'No matching records found', table_body.find('tr').find('td').text
  end

  test 'search bar filter' do
    visit @start
    gc = find('.grid-container')
    vulnerability_tabs = gc.all('.tabs-panel')[0]
    assert_equal 'is-active', vulnerability_tabs[:class][/is-active/]
    datatable_wrapper = vulnerability_tabs.find('#datatable_wrapper')
    page_row = datatable_wrapper.find('.row').find('.pagination')
    table = datatable_wrapper.find('table')
    table_body = table.find('tbody')
    nav = datatable_wrapper.find("#table-nav-top")

    filter = nav.find('.table-nav-search')
    search_bar = filter.find('input')

    fill_in('Search', with: 'The Example')
    assert_equal 6, table_body.all('tr').length
  end
end