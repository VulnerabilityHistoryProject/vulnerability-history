require 'test_helper'
require_relative '../../lib/tasks/scheduler_cve_methods'

class SchedulerTest < ActiveSupport::TestCase
  parsedToSave = {
    "CVE"=>"CVE-2011-1111",
    "announced" => "2012-05-15",
    "bounty"=>"$1000.00",
    "bounty_announced"=>{"date"=>"2012-05-15",
    "url"=>"http://googlechromereleases.blogspot.com"},
    "code_reviews"=>[39004],
    "bugs"=>[122337],
    "fixes"=>["f3e8965444b0b615ed8aabfcacc5840f6684c0c5"],
    "vccs"=>[
      {"4bab3b214e92e0884af87c4ae9287da3daff5f3d"=>{"note"=>"this is a note"}},
      {"6fe4e841191055b69f5df33002e78d75bfdcf725"=>{"note"=>"another note"}}]
  }
  parsedReleases = {"releases"=>{17=>"Dec 5th, 2011",
   18=>"Jan 30th, 2012", 19=>"Mar 26th, 2012", 20=>"May 7th, 2012", 
   21=>"Jun 18th, 2012", 22=>"Aug 6th, 2012", 23=>"Sept 17th, 2012"}
  }

  test "vulnerabilityData adds Vulnerability to db" do
    Scheduler_CVE_Methods.vulnerabilityData(parsedToSave)
    added_vuln = Vulnerability.find_by cve: "CVE-2011-1111"
    assert_equal "CVE-2011-1111", added_vuln.cve
    assert_equal parsedToSave.except("cve"), added_vuln.notes
  end
  test "vulnerabilityData adds Fix to db" do
    Scheduler_CVE_Methods.vulnerabilityData(parsedToSave)
    added_vuln = Vulnerability.find_by cve: "CVE-2011-1111"
    added_fix = Fix.find_by vulnerability_id: added_vuln.id
    assert_equal added_vuln.id, added_fix.vulnerability_id
  end
  test "vulnerabilityData adds Vcc to db" do
    Scheduler_CVE_Methods.vulnerabilityData(parsedToSave)
    added_vuln = Vulnerability.find_by cve: "CVE-2011-1111"
    added_vcc = Vcc.find_by vulnerability_id: added_vuln.id
    assert_equal added_vuln.id, added_vcc.vulnerability_id
    assert_equal 'this is a note', added_vcc.notes
  end
  test "vulnerabilityData adds Event to db" do
    Scheduler_CVE_Methods.vulnerabilityData(parsedToSave, 'bounty')
    added_event = Event.find_by detail_type: "Vulnerability"
    assert_equal "Vulnerability", added_event.detail_type
  end
  test "releaseData adds Releases to db" do
    Scheduler_CVE_Methods.releaseData(parsedReleases, "Chromium")
    added_release = Release.find_by number: 18
    assert_equal "Jan 30th, 2012".to_datetime.utc, added_release.date_released
  end
  test "add_event_styles adds EventStyle to db" do
    Scheduler_CVE_Methods.add_event_styles
    added_event_style = EventStyle.find_by event_type: "vulnerability"
    assert_equal '#ED6049', added_event_style.color
    added_event_style = EventStyle.find_by event_type: "commit_filepath"
    assert_equal '#6AA5E5', added_event_style.color
    added_event_style = EventStyle.find_by event_type: "release"
    assert_equal '#D270CA', added_event_style.color
    added_event_style = EventStyle.find_by event_type: "vcc"
    assert_equal '#ff0000', added_event_style.color
    added_event_style = EventStyle.find_by event_type: "fix"
    assert_equal '#00ff00', added_event_style.color
  end
end
