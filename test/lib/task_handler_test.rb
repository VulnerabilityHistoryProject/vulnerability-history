require 'test_helper'
require_relative '../../lib/tasks/scheduler_task_handler'
require 'fileutils'
require 'git'

class TaskHandlerTest < ActiveSupport::TestCase
  
  test "Git repo is saved" do
    gitAddress = 'https://github.com/andymeneely/chromium-vulnerabilities.git'
    gitName = 'chromium-vulnerabilities'
    gitBranch = 'master'
    findAddress = "./tmp/checkout/chromium-vulnerabilities"
    found = false
    Scheduler_Task_Handler.cloneGitRepo("./tmp/checkout/chromium-vulnerabilities", gitAddress, gitName, gitBranch)
    found = (File.exist?(findAddress))
    assert_equal true, found
  end

  test "YAML and Git Handling" do
    gitAddress = 'https://github.com/andymeneely/chromium-vulnerabilities.git'
    gitName = 'chromium-vulnerabilities'
    gitBranch = 'master'
    findAddress = "./tmp/checkout/chromium-vulnerabilities"
    found = false
    Scheduler_Task_Handler.cloneGitRepo("./tmp/checkout/chromium-vulnerabilities", gitAddress, gitName, gitBranch)
    findAddress = "./tmp/checkout/chromium-vulnerabilities"
    git_logs, ymlFiles = Scheduler_Task_Handler.yamlGitLogHandling(findAddress)
    puts git_logs
    assert_equal 1358, ymlFiles.size()
    assert_equal 2, git_logs.size()
  end

  test "YAML Parsing" do
    parsedYAML1ShouldBe = "CVE-2008-4340"
    parsedYAML2ShouldBe = "CVE-2008-4724"
    ymlAddress = "./tmp/checkout/chromium-vulnerabilities/cves/CVE-2008-4340.yml", "./tmp/checkout/chromium-vulnerabilities/cves/CVE-2008-4724.yml"
    parsedYAML = Scheduler_Task_Handler.yamlParsing(ymlAddress)
    assert_equal parsedYAML1ShouldBe, parsedYAML[0].dig("CVE")
    assert_equal parsedYAML2ShouldBe, parsedYAML[1].dig("CVE")
  end
end