require 'test_helper'
require 'event_generators/similar_events'
require 'writing'

class SimilarEventsTest < ActiveSupport::TestCase
  test 'same directory generated properly' do

    expected = [
      "<p><a href=\"/cves/CVE-2011-3092\" rel=\"nofollow\"><i class=\"vhp-icon-vulnerability\"></i>CVE-2011-3092</a> fixed in same directory this/is/a/test</p>\n",
      "<p><a href=\"/cves/CVE-2011-3092\" rel=\"nofollow\"><i class=\"vhp-icon-vulnerability\"></i>CVE-2011-3092</a> fixed in same directory this/is/a/test</p>\n",
      "<p><a href=\"/cves/CVE-2011-3092\" rel=\"nofollow\"><i class=\"vhp-icon-vulnerability\"></i>CVE-2011-3092</a> fixed in same directory webkit/port</p>\n",
      "<p><a href=\"/cves/CVE-2011-3092\" rel=\"nofollow\"><i class=\"vhp-icon-vulnerability\"></i>CVE-2011-3092</a> fixed in same directory</p>\n",
      "<p><a href=\"/cves/CVE-2011-3093\" rel=\"nofollow\"><i class=\"vhp-icon-vulnerability\"></i>CVE-2011-3093</a> fixed in same directory this/is/a/test</p>\n",
      "<p><a href=\"/cves/CVE-2011-3093\" rel=\"nofollow\"><i class=\"vhp-icon-vulnerability\"></i>CVE-2011-3093</a> fixed in same directory this/is/a/test</p>\n",
      "<p><a href=\"/cves/CVE-2011-3093\" rel=\"nofollow\"><i class=\"vhp-icon-vulnerability\"></i>CVE-2011-3093</a> fixed in same directory webkit/port</p>\n",
      "<p><a href=\"/cves/CVE-2011-3093\" rel=\"nofollow\"><i class=\"vhp-icon-vulnerability\"></i>CVE-2011-3093</a> fixed in same directory</p>\n",
      "<p><a href=\"/cves/CVE-2016-1676\" rel=\"nofollow\"><i class=\"vhp-icon-vulnerability\"></i>CVE-2016-1676</a> fixed in same directory this/is/a/test</p>\n",
      "<p><a href=\"/cves/CVE-2016-1676\" rel=\"nofollow\"><i class=\"vhp-icon-vulnerability\"></i>CVE-2016-1676</a> fixed in same directory this/is/a/test</p>\n"
    ]

    SimilarEvents.new(projects(:one)).generate
    actual = Event.where("title LIKE '%fixed in same directory%'")
                  .pluck(:title).sort
    assert_equal expected, actual
  end

  test 'same CWE events generated properly' do
    expected = [
      "<p>Another <em>Example</em> vulnerability announced</p>\n",
      "<p>Another <em>Example</em> vulnerability announced</p>\n"
    ]
    SimilarEvents.new(projects(:one)).generate
    actual = Event.where("title LIKE '%Another % vulnerability announced%'")
                  .pluck(:title).sort
    assert_equal expected, actual
  end
end
