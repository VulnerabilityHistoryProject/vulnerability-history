require 'test_helper'
require 'event_generators/similar_events'
require 'writing'

class SimilarEventsTest < ActiveSupport::TestCase

  test 'similar events created for vulns' do
    p = projects(:one)
    SimilarEvents.new(p).generate
    expected = [
      "<p>Similar vulnerability: <a href=\"/cves/CVE-2011-3092\" rel=\"nofollow\"><i class=\"vhp-icon-vulnerability\"></i>CVE-2011-3092</a> is also in this/is/a/test</p>\n",
      "<p>Similar vulnerability: <a href=\"/cves/CVE-2013-2878\" rel=\"nofollow\"><i class=\"vhp-icon-vulnerability\"></i>CVE-2013-2878</a> has the same CWE</p>\n",
      "<p>Similar vulnerability: <a href=\"/cves/CVE-2016-1676\" rel=\"nofollow\"><i class=\"vhp-icon-vulnerability\"></i>CVE-2016-1676</a> has the same CWE</p>\n",
      "<p>Similar vulnerability: <a href=\"/cves/CVE-2016-1676\" rel=\"nofollow\"><i class=\"vhp-icon-vulnerability\"></i>CVE-2016-1676</a> is also in this/is/a/test</p>\n"
    ]
    actual = Event.where("description LIKE '%Similar vulnerability:%'").
                   map{ |e| e.description }.sort
    assert_equal expected, actual
  end

end
