require 'test_helper'
require 'event_generators/fix_events'
require 'writing'

class FixEventsTest < ActiveSupport::TestCase

  setup do
    @silent_logger = TimingLogger.new(StringIO.new, '')
  end

  test 'fix events created for all vulns' do
    p = projects(:one)
    expected_desc = "Here was the commit message.\n<blockquote>\nStrip CRs from *.in files to allow building from webkit.org R=darin\n\nReview URL: http://codereview.chromium.org/39004\n\ngit-svn-id: svn://svn.chromium.org/chrome/trunk/src@11244 0039d316-1c4b-4281-b951-d872f2087c98 \n</blockquote>\n\n[Learn more about this commit](/commits/f3e8965444b0b615ed8aabfcacc5840f6684c0c5)"
    FixEvents.new(p, @silent_logger).generate
    actual = Event.where(title: "Fix for CVE-2011-3092: Strip CRs from *.in files to allow building from webkit.org")
    assert_equal 1, actual.count 
    assert_match /.*#{Regexp.escape(expected_desc.strip)}/, actual.first.description.strip
  end

end
