require 'test_helper'

class EventTest < ActiveSupport::TestCase

  test 'fixtures are loaded' do
    assert Event.any?
  end

  test 'event details can be pulled' do
    e = events(:fix1_event)
    assert_equal 'Fix: Strip CRs from *.in files to allow building from webkit.org',
                 e.detail.title
    assert e.description.starts_with? 'R=darin'
    assert_equal 'fix', e.type
    assert_equal commits(:fix1).date_created, e.date
  end

  test 'event details can pull from notes' do
    e = events(:custom_event_3)
    assert_equal "CWE Determined for CVE-2013-2878", e.title
    assert_equal "CWE was 119", e.description
    assert_equal vulnerabilities(:cve_2013_2878).date, e.date
    assert_equal "vulnerability", e.type
  end

  test 'event can have its own templates' do
    e = events(:custom_event_1)
    assert_equal 'Custom Event 1', e.title
    assert_equal 'Custom description!', e.description
    assert_equal vulnerabilities(:cve_2011_3092).date, e.date
    assert_equal "Custom type!", e.type
  end

  test 'event can have embedded details' do
    e = events(:custom_event_2)
    assert_equal 'Custom CVE-2011-3092 Event 2', e.title
    assert_equal 'CVE-2011-3092: Regex was wrong.', e.description
    assert_equal vulnerabilities(:cve_2011_3092).date, e.date
    assert_equal "CVE-2011-3092 vulnerability", e.type
  end

  test 'Event.by_fixes works' do
    v = Vulnerability.find_by(cve: 'CVE-2011-3092')
    expected = ['Fix: Strip CRs from *.in files to allow building from webkit.org',]
    actual = Event.by_fixes(v).map { |e| e.title }
    assert_equal expected, actual
  end

  test 'Event.by_vccs works' do
    v = Vulnerability.find_by(cve: 'CVE-2011-3092')
    expected = [
      "Vcc: WebKit merge 39606:39660 Review URL: http://codereview.chromium.org/17239",
      "Vcc: Remove empty unused directories from src/webkit."
    ]
    actual = Event.by_vccs(v).map { |e| e.title }
    assert_equal expected, actual
  end

  test 'Event.edits_on_vulnerable_files works' do
    v = vulnerabilities(:cve_2011_3092)
    expected = [
      'Edit: Search box support, Chromium side.BUG=9210',
    ]
    actual = Event.edits_on_vulnerable_files(v).map { |e| e.title }
    assert_equal expected, actual
  end

  test 'event query gets everything it needs' do
    v = Vulnerability.find_by(cve: 'CVE-2011-3092')
    expected = [
      "Bounty Determined for CVE-2011-3092",
      'Custom CVE-2011-3092 Event 2',
      'Custom Event 1',
      'Edit: Search box support, Chromium side.BUG=9210',
      'Fix: Strip CRs from *.in files to allow building from webkit.org',
      'Release 17!',
      'Release 19',
      "Vcc: Remove empty unused directories from src/webkit.",
      "Vcc: WebKit merge 39606:39660 Review URL: http://codereview.chromium.org/17239",
    ]
    actual = Event.by_vulnerability(v).
                   map { |e| e.title.to_s }.sort
    assert_equal expected, actual
  end

  test 'event notes in description' do
    e = events(:custom_event_3)
    assert_equal('CWE was 119', e.description)
  end

  test 'event date default works' do
    e = events(:custom_event_2)
    assert_equal(DateTime.parse('Mon, Mar 9 15:32:34 2009 +0000'),
      e.date)
  end

  test 'event notes in 2-tiered description' do
    e = events(:custom_event_4)
    assert_equal('~bounty amount was 1000.0', e.description)
  end

  test 'date template gets parsed by Date.parse' do
    e = events(:custom_event_4)
    assert_equal(DateTime.parse('Sat, 21 Mar 2009 15:32:34 +0000'),
      e.date.to_s)
  end

  # test 'event notes with rogue tilde'

  # test 'multiple notes tags'

end
